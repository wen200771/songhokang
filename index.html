<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈÄÅÈΩÅÂ∫∑ - ÂÑ™ÊÉ†Âà∏ÊäòÂÉπÂà∏Âπ≥Âè∞</title>
    <meta name="description" content="ÈÄÅÈΩÅÂ∫∑ - Âè∞ÁÅ£ÂÑ™ÊÉ†Âà∏ËàáÊäòÂÉπÂà∏Âπ≥Âè∞ÔºåÁ≤æÈÅ∏ÁæéÈ£ü„ÄÅË≥ºÁâ©„ÄÅÂ®õÊ®Ç„ÄÅÊóÖÈÅäÁ≠âÂ§öÂÖÉÂÑ™ÊÉ†ÔºåËºïÈ¨ÜÊêúÂ∞ãÊî∂ËóèÔºå‰∏ÄÈçµÊü•ÁúãË©≥ÊÉÖ„ÄÇ">
    <link rel="canonical" href="http://localhost:8000/">
    <meta name="robots" content="index,follow">
    <!-- Open Graph -->
    <meta property="og:title" content="ÈÄÅÈΩÅÂ∫∑ - ÂÑ™ÊÉ†Âà∏ÊäòÂÉπÂà∏Âπ≥Âè∞">
    <meta property="og:description" content="Á≤æÈÅ∏ÂêÑÈ°ûÁÜ±ÈñÄÂÑ™ÊÉ†ÔºåÊîØÊè¥ÊêúÂ∞ã„ÄÅÂàÜÈ°ûËàáÊî∂ËóèÔºåÊâæÂ•ΩÂ∫∑Êõ¥Âø´ÈÄü„ÄÇ">
    <meta property="og:type" content="website">
    <meta property="og:url" content="http://localhost:8000/">
    <meta property="og:image" content="http://localhost:8000/img/ÈÄÅÂ•ΩÂ∫∑ÊñáÂÆ£Á¥†Êùê (1).jpg">
    <meta property="og:locale" content="zh_TW">
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="ÈÄÅÈΩÅÂ∫∑ - ÂÑ™ÊÉ†Âà∏ÊäòÂÉπÂà∏Âπ≥Âè∞">
    <meta name="twitter:description" content="Á≤æÈÅ∏ÂêÑÈ°ûÁÜ±ÈñÄÂÑ™ÊÉ†ÔºåÊîØÊè¥ÊêúÂ∞ã„ÄÅÂàÜÈ°ûËàáÊî∂Ëóè„ÄÇ">
    <meta name="twitter:image" content="http://localhost:8000/img/ÈÄÅÂ•ΩÂ∫∑ÊñáÂÆ£Á¥†Êùê (1).jpg">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéüÔ∏è</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f8f7f6 0%, #fef5e7 30%, #fff8f0 70%, #f8f7f6 100%);
            min-height: 100vh;
            overflow-x: hidden;
            color: #333;
        }

        /* ÁßªÈô§ËÉåÊôØÂãïÁï´Ôºå‰ΩøÁî®ÈùúÊÖãÊº∏ËÆä */

        /* Liquid Glass ÊµÅÂãïÊïàÊûú - ‰øùÁïôÂÖ∂‰ªñÂãïÁï´ */

        @keyframes liquidPulse {

            0%,
            100% {
                box-shadow:
                    0 8px 32px rgba(0, 0, 0, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
            }

            50% {
                box-shadow:
                    0 12px 40px rgba(0, 0, 0, 0.15),
                    inset 0 1px 0 rgba(255, 255, 255, 0.4);
            }
        }

        /* ÁßªÈô§Âç°ÁâáÊµÆÂãïÊïàÊûúÔºåÈÅøÂÖçÂπ≤ÊìæÈñ±ËÆÄ */

        /* Pinterest È¢®Ê†ºÈ†ÇÈÉ®Â∞éËà™Ê¨Ñ */
        .header {
            background: transparent;
            padding: 8px 16px;
            position: fixed;
            top: 0;
            left: 60px;
            right: 0;
            z-index: 999;
            height: 64px;
            box-sizing: border-box;
        }

        .header.pushed {
            left: 260px;
        }

        .nav-container {
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: none;
            height: 100%;
        }

        /* Êº¢Â†°Èçµ */
        .hamburger-btn {
            display: none;
            background: rgba(248, 247, 246, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(252, 163, 17, 0.25);
            color: #333;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .hamburger-btn:focus {
            outline: 2px solid #FCA311;
            outline-offset: 2px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #FCA311;
            text-decoration: none;
            min-width: 80px;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }

        .logo:hover {
            opacity: 0.8;
        }

        .search-container {
            flex: 1;
            position: relative;
            max-width: none;
            margin: 0 16px;
            min-width: 200px;
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 50px;
            padding: 8px 16px;
            border: 1px solid rgba(252, 163, 17, 0.2);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .search-container:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(252, 163, 17, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #FCA311;
            font-size: 16px;
            opacity: 0.7;
            z-index: 1;
            pointer-events: none;
        }


        .search-input-wrapper {
            position: relative;
            flex: 1;
            display: flex;
            align-items: center;
            gap: 6px;
            min-height: 36px;
            flex-wrap: wrap;
            padding-left: 32px;
        }

        .search-container:focus-within {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(252, 163, 17, 0.4);
            box-shadow:
                0 8px 32px rgba(252, 163, 17, 0.15),
                0 0 0 3px rgba(252, 163, 17, 0.1);
            transform: translateY(-1px);
        }

        .search-box {
            border: none;
            background: transparent;
            font-size: 14px;
            outline: none;
            flex: 1;
            min-width: 120px;
            padding: 0;
            color: #333;
            font-family: inherit;
        }

        .search-box::placeholder {
            color: #666;
        }

        /* ÈªëÈáëÈÖçËâ≤ÂÑ™Âåñ */
        .coupon-card:hover {
            box-shadow: 0 12px 24px rgba(252, 163, 17, 0.15);
        }

        /* ÈÅ∏‰∏≠ÁöÑÊ®ôÁ±§Ê®£Âºè */
        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .selected-tag {
            background: #FCA311;
            color: #fff;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            animation: fadeIn 0.2s ease;
        }

        .selected-tag-remove {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 12px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }

        .selected-tag-remove:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .search-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: #FCA311;
            font-size: 18px;
            font-weight: bold;
            z-index: 10;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .user-menu {
            display: flex;
            align-items: center;
            min-width: 60px;
            position: relative;
        }

        .login-btn {
            background: rgba(252, 163, 17, 0.1);
            border: 1px solid rgba(252, 163, 17, 0.3);
            color: #333;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            background: rgba(252, 163, 17, 0.2);
            border-color: rgba(252, 163, 17, 0.4);
        }

        /* ËßíËâ≤ÁôªÂÖ•Âø´ÈÄüÂÖ•Âè£ */
        /* ËßíËâ≤‰∏ãÊãâÈÅ∏ÂñÆ */
        .role-menu {
            position: absolute;
            top: 50px;
            right: 0;
            background: white;
            border: 1px solid rgba(252, 163, 17, 0.2);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            padding: 8px;
            display: none;
            z-index: 1200;
            min-width: 120px;
        }

        .role-menu.active {
            display: block;
        }

        .role-item {
            display: block;
            width: 100%;
            padding: 10px 12px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: #333;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .role-item+.role-item {
            margin-top: 6px;
        }

        .role-item:hover {
            background: rgba(252, 163, 17, 0.15);
            color: #FCA311;
            border-color: rgba(252, 163, 17, 0.35);
        }

        /* ÊúÉÂì°ÈÅ∏ÂñÆÂæΩÁ´† */
        .menu-badge {
            background: #FCA311;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: auto;
            font-weight: 600;
            display: none;
        }

        .menu-badge.show {
            display: inline-block;
        }

        /* ÊúÉÂì°Ë®≠ÂÆöÈ†ÖÁõÆÊ®£Âºè */
        .setting-item {
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f3f4f6;
        }

        .setting-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .setting-item label {
            font-weight: 500;
            margin-bottom: 4px;
            cursor: pointer;
        }

        .setting-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #FCA311;
        }

        .setting-item small {
            display: block;
            margin-top: 4px;
        }


        /* Pinterest È¢®Ê†ºÊêúÂ∞ã‰∏ãÊãâÈÅ∏ÂñÆ */
        .search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 1001;
            margin-top: 8px;
            padding: 24px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .search-dropdown.active {
            display: block;
        }

        .search-section {
            margin-bottom: 32px;
        }

        .search-section:last-child {
            margin-bottom: 0;
        }

        .search-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
        }

        /* ÊúÄËøëÊêúÂ∞ã */
        .recent-searches {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .recent-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .recent-item:hover {
            background-color: #f1f1f1;
        }

        .recent-icon {
            margin-right: 12px;
            color: #666;
            font-size: 16px;
        }

        .recent-text {
            color: #333;
            font-size: 14px;
        }

        /* Êé®Ëñ¶ÂàÜÈ°û */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }

        .category-chip {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: rgba(248, 247, 246, 0.5);
            backdrop-filter: blur(8px);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(252, 163, 17, 0.15);
            box-shadow: 0 2px 6px rgba(252, 163, 17, 0.08);
            text-decoration: none;
        }

        .category-chip:hover {
            background: rgba(252, 163, 17, 0.08);
            border-color: rgba(252, 163, 17, 0.3);
            box-shadow: 0 4px 12px rgba(252, 163, 17, 0.15);
        }

        .category-chip-icon {
            margin-right: 8px;
            font-size: 16px;
        }

        .category-chip-text {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        /* ÁÜ±ÈñÄÊ®ôÁ±§ */
        .search-history {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .search-history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(248, 247, 246, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(252, 163, 17, 0.1);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            color: #333333;
        }

        .search-history-item:hover {
            background: rgba(252, 163, 17, 0.1);
            border-color: rgba(252, 163, 17, 0.2);
            box-shadow: 0 4px 12px rgba(252, 163, 17, 0.1);
        }

        .search-history-content {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .search-history-icon {
            color: #FCA311;
            font-size: 14px;
        }

        .search-history-text {
            color: #333333;
            font-weight: 500;
        }

        .search-history-delete {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(252, 163, 17, 0.1);
            color: #FCA311;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0.7;
        }

        .search-history-delete:hover {
            background: rgba(252, 163, 17, 0.2);
            opacity: 1;
        }

        .trending-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .trending-tag {
            padding: 8px 16px;
            background: rgba(248, 247, 246, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(252, 163, 17, 0.2);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            font-weight: 500;
            color: #333333;
            box-shadow: 0 2px 8px rgba(252, 163, 17, 0.1);
            position: relative;
        }

        .trending-tag:hover {
            background: rgba(252, 163, 17, 0.1);
            border-color: rgba(252, 163, 17, 0.4);
            color: #FCA311;
            box-shadow: 0 4px 12px rgba(252, 163, 17, 0.2);
        }

        .trending-tag.selected {
            background: rgba(252, 163, 17, 0.9);
            border-color: #FCA311;
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(252, 163, 17, 0.3);
        }

        .trending-tag.selected:hover {
            background: #FCA311;
            border-color: #FCA311;
            box-shadow: 0 6px 16px rgba(252, 163, 17, 0.4);
        }

        .category-chip.selected {
            background: rgba(252, 163, 17, 0.9);
            border-color: #FCA311;
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(252, 163, 17, 0.3);
        }

        .category-chip.selected .category-chip-text {
            color: #ffffff;
            font-weight: 600;
        }

        .category-chip.selected:hover {
            background: #FCA311;
            box-shadow: 0 6px 16px rgba(252, 163, 17, 0.4);
        }

        /* ÂÑ™ÂåñÂæåÁöÑÂ∑¶ÂÅ¥ÈÇäÊ¨Ñ */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 60px;
            height: 100vh;
            background: rgba(248, 247, 246, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(252, 163, 17, 0.2);
            border-left: none;
            border-radius: 0 0 24px 0;
            padding: 0;
            box-shadow:
                4px 0 20px rgba(252, 163, 17, 0.1),
                inset -1px 0 0 rgba(255, 255, 255, 0.8);
            overflow: hidden;
            overflow-x: hidden;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar.expanded {
            width: 260px;
            background: rgba(248, 247, 246, 0.9);
            box-shadow:
                6px 0 30px rgba(252, 163, 17, 0.15),
                inset -1px 0 0 rgba(255, 255, 255, 0.9);
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* ÂÅ¥ÈÇäÊ¨Ñ Logo ÂçÄÂ°ä */
        .sidebar-logo {
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid rgba(252, 163, 17, 0.2);
            background: rgba(252, 163, 17, 0.1);
            transition: all 0.3s ease;
            height: 64px;
            box-sizing: border-box;
        }

        .sidebar-logo .logo {
            font-size: 24px;
            font-weight: bold;
            color: transparent;
            text-decoration: none;
            transition: all 0.3s ease;
            position: relative;
        }

        .sidebar-logo .logo::before {
            content: "ÈÄÅ";
            display: flex;
            align-items: center;
            justify-content: center;
            color: #FCA311;
            font-size: 24px;
            font-weight: bold;
            transition: all 0.3s ease;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        .sidebar.expanded .sidebar-logo .logo::before {
            content: "ÈÄÅÈΩÅÂ∫∑";
            justify-content: flex-start;
            padding-left: 8px;
        }

        .sidebar.expanded .sidebar-logo {
            justify-content: flex-start;
            padding-left: 24px;
        }

        /* Áî®Êà∂Ê≠°ËøéÂçÄÂ°ä */
        /* Â∑≤ÁßªÈô§ÂÅ¥ÈÇäÊ¨ÑÊ≠°ËøéÂçÄÂ°äÁõ∏ÈóúÊ®£Âºè */

        /* ÂÅ¥ÈÇäÊ¨Ñ‰∏ªË¶ÅÂÖßÂÆπÂçÄÂüü */
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
        }

        /* ÂÅ¥ÈÇäÊ¨ÑÂçÄÂ°ä */
        .sidebar-section {
            padding: 16px 0;
        }

        .sidebar-section-title {
            padding: 0 24px 8px;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            color: #333333;
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            margin: 4px 12px;
            border-radius: 8px;
            white-space: nowrap;
            overflow: hidden;
            min-height: 48px;
        }

        .sidebar:not(.expanded) .sidebar-item {
            padding: 16px 0;
            justify-content: center;
            margin: 4px 8px;
            width: 44px;
            height: 48px;
        }

        .sidebar-item:hover {
            background: rgba(252, 163, 17, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(252, 163, 17, 0.3);
            color: #FCA311;
            box-shadow:
                0 4px 15px rgba(252, 163, 17, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            transform: translateY(-2px);
        }

        .sidebar:not(.expanded) .sidebar-item:hover {
            background: rgba(252, 163, 17, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(252, 163, 17, 0.4);
            border-radius: 12px;
            margin: 4px 8px;
            width: 44px;
            box-shadow:
                0 6px 20px rgba(252, 163, 17, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            transform: translateY(-3px) scale(1.05);
        }

        .sidebar-item.active {
            background: linear-gradient(135deg, rgba(252, 163, 17, 0.9), rgba(255, 193, 7, 0.7));
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: #000000;
            font-weight: 600;
            box-shadow:
                0 8px 25px rgba(252, 163, 17, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .sidebar-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #000000;
            border-radius: 0 3px 3px 0;
        }

        .sidebar:not(.expanded) .sidebar-item.active {
            background: linear-gradient(135deg, rgba(252, 163, 17, 0.9), rgba(255, 193, 7, 0.7));
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 12px;
            margin: 4px 8px;
            width: 44px;
            box-shadow:
                0 8px 25px rgba(252, 163, 17, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
            transform: scale(1.1);
        }

        .sidebar:not(.expanded) .sidebar-item.active::before {
            display: none;
        }

        .sidebar-icon {
            margin-right: 16px;
            font-size: 20px;
            width: 24px;
            height: 24px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .sidebar:not(.expanded) .sidebar-icon {
            margin-right: 0;
            width: 24px;
            height: 24px;
            font-size: 20px;
        }

        /* ÁßªÈô§ÂÅ¥ÈÇäÊ¨ÑÂúñÊ®ôÁöÑhoverÊîæÂ§ßÊïàÊûú */

        .sidebar-text {
            font-size: 15px;
            font-weight: 600;
            flex: 1;
            transition: all 0.3s ease;
            letter-spacing: 0.2px;
            color: #333333;
        }

        .sidebar:not(.expanded) .sidebar-text {
            display: none;
        }

        /* ÈÄöÁü•Â∞èÁ¥ÖÈªû */
        .notification-badge {
            background: #ff4444;
            color: #ffffff;
            font-size: 10px;
            font-weight: 700;
            padding: 3px 6px;
            border-radius: 12px;
            min-width: 16px;
            text-align: center;
            transition: opacity 0.3s ease;
            line-height: 1;
        }

        .sidebar:not(.expanded) .notification-badge {
            display: none;
        }

        /* Áµ±Ë®àÊï∏Â≠ó */
        .sidebar-count {
            font-size: 12px;
            color: #666666;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 12px;
            min-width: 22px;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: 700;
            border: 1px solid #d0d7de;
        }

        .sidebar:not(.expanded) .sidebar-count {
            position: absolute;
            top: 2px;
            right: 2px;
            min-width: 18px;
            height: 18px;
            padding: 2px;
            font-size: 9px;
            line-height: 1;
            background: #ff4757;
            color: white;
            border: 2px solid #f8f7f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.25);
            font-weight: 700;
            z-index: 10;
        }

        .sidebar-item.active .sidebar-count {
            background: rgba(0, 0, 0, 0.2);
            color: #000;
        }

        /* ÂàÜÈöîÁ∑öÂÑ™Âåñ */
        .sidebar-divider {
            height: 1px;
            background: #e0e0e0;
            margin: 12px 16px;
            opacity: 0.8;
        }

        /* Â∫ïÈÉ®ÂçÄÂ°ä */
        .sidebar-footer {
            margin-top: auto;
            padding: 16px 0;
            background: #f8f9fa;
            border-top: 1px solid #e1e1e1;
        }

        .sidebar-footer .sidebar-item {
            margin: 2px 12px;
            padding: 8px 12px;
        }

        /* ‰∏ªË¶ÅÂÖßÂÆπÂçÄÂüü */
        .main-content {
            margin-top: 84px;
            margin-left: 60px;
            padding: 0px 20px 20px 20px;
            min-height: calc(100vh - 84px);
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .main-content.pushed {
            margin-left: 260px;
        }

        @media (max-width: 768px) {
            .header {
                left: 0;
            }

            .main-content {
                margin-left: 0;
                padding: 12px;
            }

            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .hamburger-btn {
                display: inline-flex;
            }
        }

        /* ÁúüÊ≠£ÁöÑ Pinterest ÁÄëÂ∏ÉÊµÅÂÆπÂô® */
        .masonry-container {
            column-count: 5;
            column-gap: 16px;
        }

        .masonry-container.empty {
            column-count: 1;
        }

        /* ÈüøÊáâÂºèÁÄëÂ∏ÉÊµÅ */
        @media (min-width: 1400px) {
            .masonry-container {
                column-count: 6;
                column-gap: 20px;
            }
        }

        @media (max-width: 1200px) {
            .masonry-container {
                column-count: 4;
                column-gap: 16px;
            }
        }

        @media (max-width: 900px) {
            .masonry-container {
                column-count: 3;
                column-gap: 16px;
            }
        }

        @media (max-width: 600px) {
            .masonry-container {
                column-count: 2;
                column-gap: 12px;
            }
        }

        @media (max-width: 400px) {
            .masonry-container {
                column-count: 2;
                column-gap: 8px;
            }
        }

        /* Pinterest È¢®Ê†ºÂç°ÁâáÊ®£Âºè */
        .coupon-card {
            background: rgba(248, 247, 246, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(252, 163, 17, 0.2);
            border-radius: 24px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: inline-block;
            width: 100%;
            margin-bottom: 20px;
            break-inside: avoid;
            box-shadow:
                0 8px 32px rgba(252, 163, 17, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        /* Âç°ÁâáÊÑõÂøÉÊåâÈàïÔºàÂ∏∏ÈßêÈ°ØÁ§∫Ôºâ */
        .fav-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #ffffff;
            color: #999999;
            border: 1px solid rgba(0, 0, 0, 0.06);
            cursor: pointer;
            z-index: 2;
        }

        .fav-btn:hover {
            filter: brightness(0.95);
        }

        .fav-btn.active {
            color: #e60023;
        }

        .coupon-card:hover {
            background: rgba(248, 247, 246, 0.9);
            border-color: rgba(252, 163, 17, 0.4);
            box-shadow:
                0 16px 50px rgba(252, 163, 17, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.9),
                0 0 0 1px rgba(252, 163, 17, 0.1);
        }

        .coupon-image {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 0;
        }

        .coupon-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0);
            transition: background 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .coupon-card:hover .coupon-overlay {
            background: rgba(0, 0, 0, 0.3);
        }

        .view-btn {
            background: #FCA311;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            opacity: 0;
            transform: translateY(15px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow:
                0 8px 25px rgba(252, 163, 17, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            color: #ffffff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .view-btn:hover {
            background: #e8930f;
            box-shadow:
                0 12px 35px rgba(252, 163, 17, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
            border-color: rgba(255, 255, 255, 0.5);
            color: #ffffff;
        }

        .coupon-card:hover .view-btn {
            opacity: 1;
        }

        /* ÂΩàÁ™óÊ®£Âºè */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: rgba(248, 247, 246, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(252, 163, 17, 0.2);
            border-radius: 16px;
            max-width: 1000px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            position: relative;
            box-shadow:
                0 12px 40px rgba(252, 163, 17, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            animation: liquidPulse 6s ease-in-out infinite;
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: #fff;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            z-index: 2001;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-left {
            flex: 1;
            background: rgba(248, 247, 246, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            cursor: zoom-in;
        }

        .modal-image {
            width: auto;
            height: auto;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 12px;
        }

        .modal-right {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .store-info {
            margin-bottom: 24px;
        }

        .store-name {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .store-category {
            color: #666;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .offer-title {
            font-size: 20px;
            font-weight: 600;
            color: #FCA311;
            margin-bottom: 12px;
        }

        .offer-description {
            color: #666;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .offer-details {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .detail-label {
            font-weight: 600;
            color: #333;
        }

        .detail-value {
            color: #666;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
        }

        .btn-primary {
            flex: 1;
            background: #FCA311;
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .btn-primary:hover {
            background: #e8930f;
            color: #000;
        }

        .btn-secondary {
            flex: 1;
            background: #f1f1f1;
            color: #333;
            border: none;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn-secondary:hover {
            background: #e1e1e1;
        }

        /* ÈüøÊáâÂºèË®≠Ë®à */
        @media (max-width: 768px) {
            .nav-container {
                padding: 0 12px;
                gap: 8px;
            }

            .logo {
                font-size: 20px;
                min-width: 60px;
            }

            .search-container {
                margin: 0 8px;
                min-width: 150px;
            }

            .search-box {
                min-width: 80px;
                font-size: 14px;
            }

            .hamburger-btn {
                display: flex;
            }

            .modal-content {
                flex-direction: column;
                max-height: 95vh;
            }

            .modal-left {
                max-height: 50vh;
            }

            .modal-right {
                padding: 20px;
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        /* ÈÄ≤ÈöéÁØ©ÈÅ∏Ê®£Âºè */
        .filter-toggle-btn {
            background: transparent;
            border: none;
            border-radius: 8px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            margin-left: 8px;
            transition: all 0.3s ease;
        }

        .filter-toggle-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .filter-toggle-btn.active {
            background: rgba(252, 163, 17, 0.1);
            color: #FCA311;
        }

        .filter-panel {
            position: absolute;
            top: 100%;
            right: 0;
            width: 320px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 1000;
            margin-top: 8px;
            max-height: 70vh;
            overflow-y: auto;
        }

        /* ÈÄ≤ÈöéÁØ©ÈÅ∏Èù¢ÊùøÈüøÊáâÂºèË®≠Ë®à */
        @media (max-width: 768px) {
            .filter-panel {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100vw;
                max-width: none;
                border-radius: 0;
                z-index: 10000;
                margin-top: 0;
                max-height: 100vh;
            }

            .filter-content {
                padding: 16px;
                height: 100vh;
                display: flex;
                flex-direction: column;
            }

            .filter-header {
                position: sticky;
                top: 0;
                background: white;
                padding: 16px 0;
                margin: -16px -16px 16px -16px;
                padding-left: 16px;
                padding-right: 16px;
                border-bottom: 1px solid rgba(0, 0, 0, 0.1);
                z-index: 1;
            }

            .filter-body {
                flex: 1;
                overflow-y: auto;
                padding: 8px 0;
            }

            .filter-actions {
                position: sticky;
                bottom: 0;
                background: white;
                padding: 16px 0;
                margin: 16px -16px -16px -16px;
                padding-left: 16px;
                padding-right: 16px;
                border-top: 1px solid rgba(0, 0, 0, 0.1);
                z-index: 1;
            }

            .filter-section {
                margin-bottom: 24px;
            }
        }

        .filter-content {
            padding: 20px;
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        .filter-header h3 {
            margin: 0;
            color: #374151;
            font-size: 18px;
        }

        .filter-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .filter-close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .filter-group {
            margin-bottom: 20px;
        }

        .filter-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .filter-options {
            display: grid;
            gap: 8px;
        }

        .filter-checkbox,
        .filter-radio {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
            font-size: 14px;
        }

        .filter-checkbox:hover,
        .filter-radio:hover {
            background: #f9fafb;
        }

        .filter-checkbox input,
        .filter-radio input {
            margin-right: 8px;
            cursor: pointer;
        }

        .filter-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: #FCA311;
            box-shadow: 0 0 0 3px rgba(252, 163, 17, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 8px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #e5e7eb;
        }

        .filter-actions .btn-secondary,
        .filter-actions .btn-primary {
            flex: 1;
            padding: 10px;
            font-size: 14px;
        }

        /* ÂÄã‰∫∫Ë≥áÊñôÂΩàÁ™óÊ®£Âºè */
        .profile-modal-content {
            width: 600px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            background: rgba(248, 247, 246, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(252, 163, 17, 0.2);
            border-radius: 24px;
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            margin: auto;
        }

        .profile-modal-body {
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(252, 163, 17, 0.1);
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #FCA311 0%, #f59e0b 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-right: 16px;
            box-shadow: 0 8px 24px rgba(252, 163, 17, 0.3);
        }

        .profile-title {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
            background: linear-gradient(135deg, #FCA311 0%, #f59e0b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .profile-section {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(252, 163, 17, 0.1);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }

        .profile-section:hover {
            background: rgba(255, 255, 255, 0.9);
            border-color: rgba(252, 163, 17, 0.2);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, #FCA311 0%, #f59e0b 100%);
            border-radius: 2px;
            margin-right: 12px;
        }

        .form-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            max-width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: #FCA311;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 0 0 3px rgba(252, 163, 17, 0.1);
            transform: translateY(-1px);
        }

        .stats-section {
            background: linear-gradient(135deg, rgba(252, 163, 17, 0.05) 0%, rgba(245, 158, 11, 0.05) 100%);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            width: 100%;
            margin: 0;
        }

        @media (max-width: 500px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .profile-modal-content {
                width: 95vw;
                max-width: none;
                margin: 10px auto;
                border-radius: 16px;
            }

            .profile-modal-body {
                padding: 12px;
            }

            .profile-section {
                padding: 16px;
                margin-bottom: 16px;
            }

            .profile-header {
                margin-bottom: 12px;
                padding-bottom: 12px;
            }

            .profile-actions {
                margin-top: 16px;
                flex-direction: column;
                gap: 12px;
            }

            .form-input {
                font-size: 16px;
                /* Èò≤Ê≠¢iOSÁ∏ÆÊîæ */
            }
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(252, 163, 17, 0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(252, 163, 17, 0.2);
            box-shadow: 0 8px 24px rgba(252, 163, 17, 0.1);
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: #FCA311;
            margin-bottom: 4px;
        }

        .stat-number.green {
            color: #059669;
        }

        .stat-number.red {
            color: #dc2626;
        }

        .stat-number.purple {
            color: #7c3aed;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
        }

        .password-section {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.03) 0%, rgba(220, 38, 38, 0.03) 100%);
            border-color: rgba(239, 68, 68, 0.1);
        }

        .profile-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .profile-actions .btn-secondary,
        .profile-actions .btn-primary {
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .profile-actions .btn-secondary {
            background: rgba(156, 163, 175, 0.1);
            border: 2px solid rgba(156, 163, 175, 0.2);
            color: #6b7280;
        }

        .profile-actions .btn-secondary:hover {
            background: rgba(156, 163, 175, 0.2);
            border-color: rgba(156, 163, 175, 0.3);
        }

        .profile-actions .btn-primary {
            background: linear-gradient(135deg, #FCA311 0%, #f59e0b 100%);
            border: 2px solid transparent;
            color: white;
            box-shadow: 0 4px 15px rgba(252, 163, 17, 0.3);
        }

        .profile-actions .btn-primary:hover {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 8px 25px rgba(252, 163, 17, 0.4);
        }

        /* Âπ´Âä©‰∏≠ÂøÉÊ®£Âºè */
        .help-item {
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            border: 1px solid rgba(252, 163, 17, 0.1);
        }

        .help-item h4 {
            margin: 0 0 8px 0;
            color: #374151;
            font-size: 16px;
            font-weight: 600;
        }

        .help-item p {
            margin: 0;
            color: #6b7280;
            line-height: 1.6;
        }

        .help-item:last-child {
            margin-bottom: 0;
        }
    </style>
</head>

<body>
    <!-- Pinterest È¢®Ê†ºÈ†ÇÈÉ®Â∞éËà™Ê¨Ñ -->
    <header class="header">
        <div class="nav-container">
            <button class="hamburger-btn" id="hamburgerBtn" aria-label="ÈñãÂïüÈÅ∏ÂñÆ" aria-expanded="false">‚ò∞</button>
            <div class="search-container">
                <div class="search-icon">üîç</div>
                <div class="search-input-wrapper" id="searchWrapper">
                    <div class="selected-tags" id="selectedTags"></div>
                    <input type="text" class="search-box" placeholder="ÊêúÂ∞ãÂÑ™ÊÉ†Âà∏„ÄÅÂ∫óÂÆ∂ÊàñÂàÜÈ°û..." id="searchInput">
                </div>
                <button class="filter-toggle-btn" id="filterToggleBtn" title="ÈÄ≤ÈöéÁØ©ÈÅ∏">‚öôÔ∏è</button>
                <div class="search-dropdown" id="searchDropdown">
                    <!-- ÊêúÂ∞ãÁ¥ÄÈåÑ -->
                    <div class="search-section" id="searchHistorySection">
                        <h3 class="search-section-title">ÊêúÂ∞ãÁ¥ÄÈåÑ</h3>
                        <div class="search-history" id="searchHistory">
                            <!-- ÂãïÊÖãÁîüÊàêÁöÑÊêúÂ∞ãÁ¥ÄÈåÑÈ†ÖÁõÆ -->
                        </div>
                    </div>

                    <!-- ÁÜ±ÈñÄÊêúÂ∞ã -->
                    <div class="search-section">
                        <h3 class="search-section-title">ÁÜ±ÈñÄÊêúÂ∞ã</h3>
                        <div class="trending-tags">
                            <div class="trending-tag" data-tag="ÁæéÈ£üÂÑ™ÊÉ†">ÁæéÈ£üÂÑ™ÊÉ†</div>
                            <div class="trending-tag" data-tag="ÈôêÊôÇÁâπË≥£">ÈôêÊôÇÁâπË≥£</div>
                            <div class="trending-tag" data-tag="Ë≤∑‰∏ÄÈÄÅ‰∏Ä">Ë≤∑‰∏ÄÈÄÅ‰∏Ä</div>
                            <div class="trending-tag" data-tag="Êñ∞Â∫óÈñãÂπï">Êñ∞Â∫óÈñãÂπï</div>
                        </div>
                    </div>

                    <!-- ÂàÜÈ°ûÁÄèË¶Ω -->
                    <div class="search-section">
                        <h3 class="search-section-title">ÂàÜÈ°ûÁÄèË¶Ω</h3>
                        <div class="category-grid" id="searchCategoryGrid"></div>
                    </div>

                </div>

                <!-- ÈÄ≤ÈöéÁØ©ÈÅ∏Èù¢Êùø -->
                <div class="filter-panel" id="filterPanel" style="display: none;">
                    <div class="filter-content">
                        <div class="filter-header">
                            <h3>üîç ÈÄ≤ÈöéÁØ©ÈÅ∏</h3>
                            <button class="filter-close" onclick="closeFilterPanel()">√ó</button>
                        </div>

                        <!-- ÂàÜÈ°ûÁØ©ÈÅ∏ -->
                        <div class="filter-group">
                            <label class="filter-label">ÂàÜÈ°û</label>
                            <div class="filter-options" id="categoryFilters"></div>
                        </div>

                        <!-- Âà∞ÊúüÊôÇÈñì -->
                        <div class="filter-group">
                            <label class="filter-label">Âà∞ÊúüÊôÇÈñì</label>
                            <div class="filter-options">
                                <label class="filter-radio">
                                    <input type="radio" name="expiry" value="all" checked> ÂÖ®ÈÉ®
                                </label>
                                <label class="filter-radio">
                                    <input type="radio" name="expiry" value="week"> ‰∏ÄÈÄ±ÂÖßÂà∞Êúü
                                </label>
                                <label class="filter-radio">
                                    <input type="radio" name="expiry" value="month"> ‰∏ÄÂÄãÊúàÂÖßÂà∞Êúü
                                </label>
                                <label class="filter-radio">
                                    <input type="radio" name="expiry" value="future"> Èï∑ÊúüÊúâÊïà
                                </label>
                            </div>
                        </div>

                        <!-- ÊéíÂ∫èÈÅ∏È†Ö -->
                        <div class="filter-group">
                            <label class="filter-label">ÊéíÂ∫èÊñπÂºè</label>
                            <select id="sortSelect" class="filter-select">
                                <option value="default">È†êË®≠ÊéíÂ∫è</option>
                                <option value="newest">ÊúÄÊñ∞ÂÑ™ÊÉ†</option>
                                <option value="expiry">Âç≥Â∞áÂà∞Êúü</option>
                                <option value="popular">ÊúÄÂèóÊ≠°Ëøé</option>
                                <option value="category">‰æùÂàÜÈ°ûÊéíÂ∫è</option>
                            </select>
                        </div>

                        <!-- Êìç‰ΩúÊåâÈàï -->
                        <div class="filter-actions">
                            <button class="btn-secondary" onclick="clearAllFilters()">Ê∏ÖÈô§ÁØ©ÈÅ∏</button>
                            <button class="btn-primary" onclick="applyAdvancedFilters()">Â•óÁî®ÁØ©ÈÅ∏</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="user-menu">
                <button class="login-btn" title="ÁôªÂÖ•" id="loginIconBtn">üë§</button>
            </div>
            <div class="role-menu" id="roleMenu">
                <button class="role-item" data-role="customer">‰∏ÄËà¨Áî®Êà∂</button>
                <button class="role-item" data-role="vendor">Âª†ÂïÜÂæåÂè∞</button>
                <button class="role-item" data-role="admin">ÁÆ°ÁêÜÂæåÂè∞</button>
            </div>
        </div>
    </header>

    <!-- Ë°åÂãïË£ùÁΩÆÈÅÆÁΩ© -->
    <div id="backdrop" style="position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:998;"></div>

    <!-- ÂÑ™ÂåñÂæåÁöÑÂ∑¶ÂÅ¥ÈÇäÊ¨Ñ -->
    <aside class="sidebar">
        <!-- Logo ÂçÄÂ°ä -->
        <div class="sidebar-logo">
            <a href="#" class="logo">ÈÄÅÈΩÅÂ∫∑</a>
        </div>



        <!-- ÂèØÊªæÂãïÁöÑ‰∏ªË¶ÅÂÖßÂÆπ -->
        <div class="sidebar-content">
            <!-- ‰∏ªË¶ÅÂäüËÉΩÂçÄÂ°ä -->
            <div class="sidebar-section">
                <div class="sidebar-item active" data-action="home">
                    <span class="sidebar-icon">üè†</span>
                    <span class="sidebar-text">È¶ñÈ†Å</span>
                </div>
                <div class="sidebar-item" data-action="favorites">
                    <span class="sidebar-icon">‚ù§Ô∏è</span>
                    <span class="sidebar-text">ÊàëÁöÑÊî∂Ëóè</span>
                    <span class="sidebar-count" id="favCount" style="display:none;"></span>
                </div>
                <div class="sidebar-item" data-action="history">
                    <span class="sidebar-icon">üïí</span>
                    <span class="sidebar-text">ÁÄèË¶ΩË®òÈåÑ</span>
                    <span class="sidebar-count" id="historyCount" style="display:none;"></span>
                </div>
            </div>

            <div class="sidebar-divider"></div>

            <!-- Êé®Ëñ¶ÂäüËÉΩÂçÄÂ°ä -->
            <div class="sidebar-section">
                <div class="sidebar-item" data-action="hot">
                    <span class="sidebar-icon">üî•</span>
                    <span class="sidebar-text">ÁÜ±ÈñÄÂÑ™ÊÉ†</span>
                    <span class="sidebar-count" id="hotCount" style="display:none;"></span>
                </div>
                <div class="sidebar-item" data-action="nearby">
                    <span class="sidebar-icon">üìç</span>
                    <span class="sidebar-text">ÈôÑËøëÂÑ™ÊÉ†</span>
                    <span class="sidebar-count" id="nearbyCount" style="display:none;"></span>
                </div>
                <div class="sidebar-item" data-action="limited">
                    <span class="sidebar-icon">‚è∞</span>
                    <span class="sidebar-text">ÈôêÊôÇÊ¥ªÂãï</span>
                    <span class="sidebar-count" id="limitedCount" style="display:none;"></span>
                </div>
            </div>

        </div>

        <!-- Â∫ïÈÉ®Ë®≠ÂÆöÂçÄÂ°ä -->
        <div class="sidebar-footer">
            <div class="sidebar-item" data-action="settings">
                <span class="sidebar-icon">‚öôÔ∏è</span>
                <span class="sidebar-text">Ë®≠ÂÆö</span>
            </div>
            <div class="sidebar-item" data-action="help">
                <span class="sidebar-icon">‚ùì</span>
                <span class="sidebar-text">Âπ´Âä©‰∏≠ÂøÉ</span>
            </div>
        </div>
    </aside>

    <!-- ‰∏ªË¶ÅÂÖßÂÆπ -->
    <main class="main-content">
        <div class="masonry-container" id="masonryContainer">
            <!-- ÂÑ™ÊÉ†Âà∏Âç°ÁâáÂ∞áÁî± JavaScript ÂãïÊÖãÁîüÊàê -->
        </div>
    </main>

    <!-- ÂΩàÁ™ó -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <button class="modal-close" id="modalClose">√ó</button>
            <div class="modal-left">
                <picture id="modalPicture">
                    <source id="modalSourceWebp" type="image/webp">
                    <img src="" alt="ÂÑ™ÊÉ†Âà∏" class="modal-image" id="modalImage" width="900" height="1200"
                        decoding="async">
                </picture>
            </div>
            <div class="modal-right">
                <div class="store-info">
                    <h2 class="store-name" id="storeName">Â∫óÂÆ∂ÂêçÁ®±</h2>
                    <p class="store-category" id="storeCategory">ÁæéÈ£üÈ§êÈ£≤</p>
                </div>
                <h3 class="offer-title" id="offerTitle">ÂÑ™ÊÉ†Ê¥ªÂãïÊ®ôÈ°å</h3>
                <p class="offer-description" id="offerDescription">
                    ÂÑ™ÊÉ†Ê¥ªÂãïË©≥Á¥∞Ë™™ÊòéÔºåÂåÖÂê´‰ΩøÁî®Ê¢ù‰ª∂„ÄÅÈÅ©Áî®ÁØÑÂúçÁ≠âË≥áË®ä„ÄÇ
                </p>
                <div class="offer-details">
                    <div class="detail-item">
                        <span class="detail-label">ÂÑ™ÊÉ†ÊúüÈôê</span>
                        <span class="detail-value" id="offerExpiry">2024/12/31</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">‰ΩøÁî®Ê¨°Êï∏</span>
                        <span class="detail-value" id="offerUsage">ÊØè‰∫∫ÈôêÁî®‰∏ÄÊ¨°</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Â∫óÂÆ∂Âú∞ÂùÄ</span>
                        <span class="detail-value" id="storeAddress">Âè∞ÂåóÂ∏Ç‰ø°Áæ©ÂçÄ‰ø°Áæ©Ë∑Ø‰∫îÊÆµ7Ëôü</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">ËÅØÁµ°ÈõªË©±</span>
                        <span class="detail-value" id="storePhone">02-2345-6789</span>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn-primary" onclick="useCoupon(currentCoupon)">Á´ãÂç≥‰ΩøÁî®</button>
                    <button class="btn-secondary" onclick="toggleFavoriteFromModal()">Êî∂ËóèÂÑ™ÊÉ†</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÂΩ±ÂÉèÁáàÁÆ± -->
    <div class="modal-overlay" id="lightboxOverlay" style="background: rgba(0,0,0,0.95); display: none; z-index: 3000;">
        <button class="modal-close" id="lightboxClose" style="background: rgba(255,255,255,0.2);">√ó</button>
        <div
            style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; cursor: zoom-out;">
            <img id="lightboxImage" alt="È†êË¶Ω" style="max-width: 95vw; max-height: 95vh; object-fit: contain;">
        </div>
    </div>

    <!-- ÁôªÂÖ•/Ë®ªÂÜäÂΩàÁ™ó -->
    <div class="modal-overlay" id="authOverlay" style="display: none;">
        <div class="modal-content" style="max-width: 560px;">
            <button class="modal-close" id="authClose">√ó</button>
            <div style="flex:1; padding: 28px; overflow-y:auto;">
                <h2 style="margin-bottom: 12px;">ÊúÉÂì°‰∏≠ÂøÉ</h2>
                <div style="display:flex; gap:8px; margin-bottom:16px;">
                    <button id="tabLogin" class="btn-secondary" style="flex:1;">ÁôªÂÖ•</button>
                    <button id="tabRegister" class="btn-secondary" style="flex:1;">Ë®ªÂÜä</button>
                </div>
                <form id="loginForm" style="display:block;">
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <input id="loginUsername" type="text" placeholder="Áî®Êà∂ÂêçÊàñEmail"
                            style="padding:10px; border-radius:10px; border:1px solid #ddd;">
                        <input id="loginPassword" type="password" placeholder="ÂØÜÁ¢º"
                            style="padding:10px; border-radius:10px; border:1px solid #ddd;">
                        <button type="submit" class="btn-primary">ÁôªÂÖ•</button>
                    </div>
                </form>
                <form id="registerForm" style="display:none;">
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <input id="regUsername" type="text" placeholder="Áî®Êà∂Âêç"
                            style="padding:10px; border-radius:10px; border:1px solid #ddd;">
                        <input id="regEmail" type="email" placeholder="Email"
                            style="padding:10px; border-radius:10px; border:1px solid #ddd;">
                        <input id="regPassword" type="password" placeholder="ÂØÜÁ¢º(‚â•6‰Ωç)"
                            style="padding:10px; border-radius:10px; border:1px solid #ddd;">
                        <input id="regPassword2" type="password" placeholder="Á¢∫Ë™çÂØÜÁ¢º"
                            style="padding:10px; border-radius:10px; border:1px solid #ddd;">
                        <input id="regPhone" type="text" placeholder="ÊâãÊ©ü(ÈÅ∏Â°´)"
                            style="padding:10px; border-radius:10px; border:1px solid #ddd;">
                        <div id="vendorFields" style="display:none;">
                            <input id="regCompany" type="text" placeholder="ÂÖ¨Âè∏ÂêçÁ®±(Âª†ÂïÜÂøÖÂ°´)"
                                style="padding:10px; border-radius:10px; border:1px solid #ddd; margin-top:6px;">
                        </div>
                        <button type="submit" class="btn-primary">Âª∫Á´ãÂ∏≥Ëôü</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ÊêúÂ∞ãÁ¥ÄÈåÑÁÆ°ÁêÜ
        let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');

        function saveSearchHistory(query) {
            if (!query.trim()) return;

            // ÁßªÈô§ÈáçË§áÈ†ÖÁõÆ
            searchHistory = searchHistory.filter(item => item !== query);
            // Ê∑ªÂä†Âà∞ÈñãÈ†≠
            searchHistory.unshift(query);
            // ÈôêÂà∂ÊúÄÂ§ö‰øùÂ≠ò10Á≠ÜÁ¥ÄÈåÑ
            searchHistory = searchHistory.slice(0, 10);

            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
            renderSearchHistory();
        }

        function removeSearchHistory(query) {
            searchHistory = searchHistory.filter(item => item !== query);
            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
            renderSearchHistory();
        }

        function renderSearchHistory() {
            const historyContainer = document.getElementById('searchHistory');
            const historySection = document.getElementById('searchHistorySection');

            if (searchHistory.length === 0) {
                historySection.style.display = 'none';
                return;
            }

            historySection.style.display = 'block';
            historyContainer.innerHTML = '';

            searchHistory.forEach(query => {
                const historyItem = document.createElement('div');
                historyItem.className = 'search-history-item';
                historyItem.innerHTML = `
                    <div class="search-history-content" onclick="selectSearchHistory('${query}')">
                        <span class="search-history-icon">üïí</span>
                        <span class="search-history-text">${query}</span>
                    </div>
                    <div class="search-history-delete" onclick="event.stopPropagation(); removeSearchHistory('${query}')" title="Âà™Èô§">
                        √ó
                    </div>
                `;
                historyContainer.appendChild(historyItem);
            });
        }

        function selectSearchHistory(query) {
            const searchInput = document.getElementById('searchInput');
            searchInput.value = query;
            saveSearchHistory(query);
            performSearch();
            closeSearchDropdown();
        }

        // ÈÅ∏‰∏≠ÁöÑÊ®ôÁ±§Èô£Âàó
        let selectedTags = [];
        let currentCoupon = null;
        let currentView = 'home';

        // Êú¨Âú∞ÂÑ≤Â≠òÈçµÂêç
        // ÂâçÂè∞‰ΩøÁî®Áç®Á´ãÁöÑ token keyÔºåÈÅøÂÖçËàáÁÆ°ÁêÜÂì°ÂæåÂè∞Ë°ùÁ™Å
        const LS_TOKEN = 'authToken_customer';
        const LS_USER = 'authUser';
        // È°çÂ§ñÁÇ∫Ê∏¨Ë©¶ÈöéÊÆµÊèê‰æõ‰∏âÂÄãËßíËâ≤Â∞àÂ±¨ tokenÔºåÂÖÅË®±ÂêåË£ùÁΩÆÂêåÊôÇÁôªÂÖ•
        const ROLE_TOKENS = {
            admin: 'authToken_admin',
            vendor: 'authToken_vendor',
            customer: 'authToken_customer'
        };
        const LS_FAVORITES = 'favorites';
        const LS_HISTORY = 'viewHistory';

        // Ë¶ñÂúñÁãÄÊÖãËàáÂà§Êñ∑
        function setView(mode) {
            currentView = mode === 'favorites' ? 'favorites' : 'home';
            const url = new URL(location.href);
            if (currentView === 'favorites') url.searchParams.set('view', 'favorites');
            else url.searchParams.delete('view');
            history.replaceState({}, '', url);
            document.body.classList.toggle('view-favorites', currentView === 'favorites');
        }
        function isFavoritesView() {
            return currentView === 'favorites' || document.body.classList.contains('view-favorites');
        }

        // Auth helpers
        const getToken = () => localStorage.getItem(LS_TOKEN) || '';
        const getUser = () => { try { return JSON.parse(localStorage.getItem(LS_USER) || 'null'); } catch { return null; } };
        function setAuth(token, user) { localStorage.setItem(LS_TOKEN, token); localStorage.setItem(LS_USER, JSON.stringify(user || {})); updateLoginUI(); }
        function clearAuth() { localStorage.removeItem(LS_TOKEN); localStorage.removeItem(LS_USER); updateLoginUI(); }
        function isLoggedIn() { return !!getToken(); }

        // ÂÑ™ÊÉ†Âà∏Ë≥áÊñôÔºàÂ∞áÁî± API Â°´ÂÖÖÔºõËã• API ÁÑ°Ë≥áÊñôÂâá‰ΩøÁî®Êú¨Âú∞ÂÅáË≥áÊñôÔºâ
        let coupons = [];
        let currentUser = null;

        // ÁîüÊàêÂÅáË≥áÊñôÔºà‰ΩúÁÇ∫ API ÁÑ°Ë≥áÊñôÊôÇÁöÑÂæåÂÇôÔºâ
        function buildDummyCoupons() {
            coupons = [];
            const categories = ['ÁæéÈ£üÈ§êÈ£≤', 'Ë≥ºÁâ©ÂïÜÂüé', 'ÁæéÂÆπ‰øùÈ§ä', '‰ºëÈñíÂ®õÊ®Ç', 'ÊóÖÈÅä‰ΩèÂÆø', 'ÂÅ•Â∫∑ÈÜ´ÁôÇ'];
            const storeTypes = {
                'ÁæéÈ£üÈ§êÈ£≤': ['È§êÂª≥', 'ÂíñÂï°Âª≥', 'Â∞èÂêÉÂ∫ó', 'ÁÅ´ÈçãÂ∫ó', 'ÁáíÁÉ§Â∫ó'],
                'Ë≥ºÁâ©ÂïÜÂüé': ['ÊúçÈ£æÂ∫ó', '3CË≥£Â†¥', 'Êõ∏Â∫ó', 'Ë∂ÖÂ∏Ç', 'ÁôæË≤®'],
                'ÁæéÂÆπ‰øùÈ§ä': ['ÁæéÈ´ÆÊ≤ôÈæç', 'ÁæéÁî≤Â∫ó', 'SPAÊúÉÈ§®', 'ÁæéÂÆπÈô¢', 'ÊåâÊë©Â∫ó'],
                '‰ºëÈñíÂ®õÊ®Ç': ['KTV', 'ÈõªÂΩ±Èô¢', 'ÈÅäÊà≤Â†¥', 'Á∂≤Âíñ', '‰øùÈΩ°ÁêÉÈ§®'],
                'ÊóÖÈÅä‰ΩèÂÆø': ['È£ØÂ∫ó', 'Ê∞ëÂÆø', 'ÊóÖË°åÁ§æ', 'ÁßüËªäË°å', 'ÊôØÈªû'],
                'ÂÅ•Â∫∑ÈÜ´ÁôÇ': ['Ë®∫ÊâÄ', 'Ëó•Â±Ä', 'ÂÅ•Ë∫´Êàø', 'ÁëúÁèàÊïôÂÆ§', 'Áâ©ÁêÜÊ≤ªÁôÇ']
            };
            for (let i = 1; i <= 50; i++) {
                const category = categories[Math.floor(Math.random() * categories.length)];
                const storeType = storeTypes[category][Math.floor(Math.random() * storeTypes[category].length)];

                coupons.push({
                    id: i,
                    image: `img/ÈÄÅÂ•ΩÂ∫∑ÊñáÂÆ£Á¥†Êùê (${i}).jpg`,
                    storeName: `${storeType}${i}`,
                    category: category,
                    title: `ÈôêÊôÇÂÑ™ÊÉ†Ê¥ªÂãï ${i}`,
                    description: `ÈÄôÊòØÁ¨¨${i}ÂÄãÂÑ™ÊÉ†Âà∏ÁöÑË©≥Á¥∞Ë™™ÊòéÔºåÂåÖÂê´ÂêÑÁ®Æ‰ΩøÁî®Ê¢ù‰ª∂ÂíåÈôêÂà∂„ÄÇ`,
                    expiry: '2024/12/31',
                    usage: 'ÊØè‰∫∫ÈôêÁî®‰∏ÄÊ¨°',
                    address: `Âè∞ÂåóÂ∏Ç‰ø°Áæ©ÂçÄ‰ø°Áæ©Ë∑Ø‰∫îÊÆµ${i}Ëôü`,
                    phone: `02-2${String(i).padStart(3, '0')}-${String(i * 10).padStart(4, '0')}`
                });
            }
        }

        // Âæû API ËºâÂÖ•Ë≥áÊñô
        async function loadCouponsFromApi() {
            try {
                const res = await fetch('api/coupons?page=1&pageSize=50');
                const json = await res.json();
                const items = json?.data?.coupons || [];
                if (Array.isArray(items) && items.length > 0) {
                    coupons = items.map((item, idx) => ({
                        id: item.id || idx + 1,
                        image: item.image && item.image.trim() !== '' ? item.image : `img/ÈÄÅÂ•ΩÂ∫∑ÊñáÂÆ£Á¥†Êùê (${(idx % 50) + 1}).jpg`,
                        storeName: item.storeName || 'Âêà‰ΩúÂ∫óÂÆ∂',
                        category: item.category || '‰∏ÄËà¨ÂÑ™ÊÉ†',
                        title: item.title || 'ÂÑ™ÊÉ†Ê¥ªÂãï',
                        description: item.description || 'Ë©≥ÊÉÖË´ãË¶ãÊ¥ªÂãïË™™Êòé„ÄÇ',
                        expiry: item.expiry || '',
                        usage: item.usage || 'ÊØè‰∫∫ÈôêÁî®‰∏ÄÊ¨°',
                        address: item.address || '',
                        phone: item.phone || ''
                    }));
                    renderCoupons(coupons);
                } else {
                    buildDummyCoupons();
                    renderCoupons(coupons);
                }
            } catch (e) {
                buildDummyCoupons();
                renderCoupons(coupons);
            }
        }

        // Âæû API ËºâÂÖ•ÂàÜÈ°û‰∏¶Ê∏≤ÊüìÂà∞ÊêúÂ∞ã‰∏ãÊãâËàáÈÄ≤ÈöéÁØ©ÈÅ∏
        async function loadCategories() {
            try {
                const res = await fetch('api/categories?active=1');
                const json = await res.json();
                const items = Array.isArray(json?.data) ? json.data : json?.data?.items || [];
                const categories = items.length > 0 ? items : [
                    { name: 'ÁæéÈ£üÈ§êÈ£≤', icon: 'üçΩÔ∏è' },
                    { name: 'Ë≥ºÁâ©ÂïÜÂüé', icon: 'üõçÔ∏è' },
                    { name: 'ÁæéÂÆπ‰øùÈ§ä', icon: 'üíÑ' },
                    { name: '‰ºëÈñíÂ®õÊ®Ç', icon: 'üéÆ' },
                    { name: 'ÊóÖÈÅä‰ΩèÂÆø', icon: '‚úàÔ∏è' },
                    { name: 'ÂÅ•Â∫∑ÈÜ´ÁôÇ', icon: 'üè•' }
                ];

                // ÊêúÂ∞ã‰∏ãÊãâÔºöÂàÜÈ°ûÁÄèË¶Ω chips
                const grid = document.getElementById('searchCategoryGrid');
                if (grid) {
                    grid.innerHTML = categories.map(cat => `
                        <div class="category-chip" data-category="${cat.slug || cat.name}">
                            <span class="category-chip-icon">${cat.icon || ''}</span>
                            <span class="category-chip-text">${cat.name}</span>
                        </div>
                    `).join('');

                    // Á∂ÅÂÆöÈªûÊìä‰∫ã‰ª∂
                    grid.querySelectorAll('.category-chip').forEach(item => {
                        item.addEventListener('click', () => {
                            const categoryText = item.querySelector('.category-chip-text').textContent;
                            const isSelected = selectedTags.some(tag => tag.text === categoryText);
                            if (isSelected) { removeTag(categoryText); }
                            else { addTag(categoryText, 'category'); saveSearchHistory(categoryText); }
                            updateDropdownSelection();
                        });
                    });
                }

                // ÈÄ≤ÈöéÁØ©ÈÅ∏Ôºöcheckbox ÂàóË°®
                const filters = document.getElementById('categoryFilters');
                if (filters) {
                    filters.innerHTML = categories.map(cat => `
                        <label class="filter-checkbox">
                            <input type="checkbox" value="${cat.name}"> ${cat.name}
                        </label>
                    `).join('');
                }
            } catch (e) {
                // ÈùúÈªòÂ§±ÊïóÂç≥ÂèØÔºå‰ªçÂèØÁî®È†êË®≠ÂÅáË≥áÊñô
            }
        }

        // Ê∏≤ÊüìÂÑ™ÊÉ†Âà∏Âç°Áâá - Pinterest È¢®Ê†º
        function renderCoupons(couponsToRender = coupons) {
            const container = document.getElementById('masonryContainer');
            container.classList.remove('empty');
            container.innerHTML = '';

            // Â¶ÇÊûúÊòØÊî∂ËóèË¶ñÂúñÔºåÂè™È°ØÁ§∫Êî∂ËóèÁöÑÂÑ™ÊÉ†Âà∏
            if (isFavoritesView()) {
                const favoriteIds = new Set(getFavorites());
                couponsToRender = couponsToRender.filter(coupon => favoriteIds.has(coupon.id));

                // Â¶ÇÊûúÊ≤íÊúâÊî∂ËóèÁöÑÂÑ™ÊÉ†Âà∏ÔºåÈ°ØÁ§∫Á©∫ÁãÄÊÖã
                if (couponsToRender.length === 0) {
                    renderEmptyFavorites();
                    return;
                }
            }

            couponsToRender.forEach((coupon, index) => {
                const card = document.createElement('div');
                card.className = 'coupon-card';
                card.setAttribute('data-id', String(coupon.id));
                card.addEventListener('click', (ev) => {
                    const t = ev.target;
                    if (t.closest('[data-action="quick-fav"]') || t.closest('[data-action="remove-fav"]')) {
                        // ÈªûÊìäÊÑõÂøÉÊàñÁßªÈô§Êî∂Ëóè‰∏çÈñãÂïüË©≥ÊÉÖ
                        return;
                    }
                    openModal(coupon);
                });

                // Ê∑ªÂä†ËºâÂÖ•ÂãïÁï´
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';

                const webp = coupon.image.replace(/\.jpg$/i, '.webp');
                const favIdsSet = new Set(getFavorites());
                const isFav = favIdsSet.has(coupon.id);
                card.innerHTML = `
                    <picture>
                        <source srcset="${webp}" type="image/webp">
                        <img src="${coupon.image}" alt="${coupon.title}" class="coupon-image" loading="lazy" decoding="async" width="800" height="1200">
                    </picture>
                    <button class="fav-btn ${isFav ? 'active' : ''}" data-action="quick-fav" data-id="${coupon.id}">${isFav ? '‚ù§' : '‚ô°'}</button>
                    <div class="coupon-overlay">
                        <button class="view-btn">Êü•ÁúãÂÑ™ÊÉ†</button>
                    </div>
                `;

                container.appendChild(card);

                // Âª∂ÈÅ≤È°ØÁ§∫ÂãïÁï´
                setTimeout(() => {
                    card.style.transition = 'all 0.4s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 50);
            });
        }

        // ÊàëÁöÑÊî∂ËóèÁÇ∫Á©∫ÊôÇÁöÑÁï´Èù¢
        function renderEmptyFavorites() {
            const container = document.getElementById('masonryContainer');
            container.classList.add('empty');
            container.innerHTML = `
                <div style="display:flex;align-items:center;justify-content:center;width:100%;min-height:40vh;">
                    <div style="max-width:640px;width:90%;background:rgba(248,247,246,0.85);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(252,163,17,0.2);border-radius:24px;padding:32px;box-shadow:0 12px 40px rgba(252,163,17,0.15), inset 0 1px 0 rgba(255,255,255,0.9);text-align:center;">
                        <div style="font-size:20px;color:#333;font-weight:700;margin-bottom:8px;">ÁõÆÂâçÊ≤íÊúâÊî∂Ëóè</div>
                        <div style="font-size:14px;color:#666;margin-bottom:18px;">ÂèØ‰ª•Âú®Âç°ÁâáÂè≥‰∏äËßíÈªû <span style=\"color:#e60023\">‚ù§</span> Âä†ÂÖ•Êî∂Ëóè</div>
                        <button class="btn-primary" id="backToHomeBtn">ÂõûÂà∞È¶ñÈ†Å</button>
                    </div>
                </div>`;
            const btn = document.getElementById('backToHomeBtn');
            if (btn) btn.addEventListener('click', () => { resetToHomepage(); });
        }

        // ÁÄèË¶ΩË®òÈåÑÁÇ∫Á©∫ÊôÇÁöÑÁï´Èù¢
        function renderEmptyHistory() {
            const container = document.getElementById('masonryContainer');
            container.classList.add('empty');
            container.innerHTML = `
                <div style="display:flex;align-items:center;justify-content:center;width:100%;min-height:40vh;">
                    <div style="max-width:640px;width:90%;background:rgba(248,247,246,0.85);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(252,163,17,0.2);border-radius:24px;padding:32px;box-shadow:0 12px 40px rgba(252,163,17,0.15), inset 0 1px 0 rgba(255,255,255,0.9);text-align:center;">
                        <div style="font-size:20px;color:#333;font-weight:700;margin-bottom:8px;">ÁõÆÂâçÊ≤íÊúâÁÄèË¶ΩË®òÈåÑ</div>
                        <div style="font-size:14px;color:#666;margin-bottom:18px;">ÈªûÊìäÂÑ™ÊÉ†Âà∏Âç°ÁâáÊü•ÁúãË©≥ÊÉÖÂæåÊúÉËá™ÂãïË®òÈåÑ</div>
                        <button class="btn-primary" id="backToHomeFromHistory">ÂõûÂà∞È¶ñÈ†Å</button>
                    </div>
                </div>`;
            const btn = document.getElementById('backToHomeFromHistory');
            if (btn) btn.addEventListener('click', () => { resetToHomepage(); });
        }

        // Ê∑ªÂä†ÁÄèË¶ΩË®òÈåÑÊ∏ÖÈô§ÊåâÈàï
        function addHistoryClearButton() {
            // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑÊåâÈàï
            const existingButton = document.getElementById('historyClearButton');
            if (existingButton) {
                existingButton.remove();
            }

            // ÂâµÂª∫Ê∏ÖÈô§ÊåâÈàï
            const clearButton = document.createElement('div');
            clearButton.id = 'historyClearButton';
            clearButton.style.cssText = `
                position: fixed;
                top: 120px;
                right: 24px;
                z-index: 1000;
                background: rgba(220, 38, 38, 0.9);
                backdrop-filter: blur(10px);
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 12px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 8px;
            `;

            clearButton.innerHTML = `
                <span>üóëÔ∏è</span>
                <span>Ê∏ÖÈô§ÊâÄÊúâË®òÈåÑ</span>
            `;

            // Ê∑ªÂä†hoverÊïàÊûú
            clearButton.addEventListener('mouseenter', () => {
                clearButton.style.background = 'rgba(220, 38, 38, 1)';
                clearButton.style.transform = 'translateY(-2px)';
                clearButton.style.boxShadow = '0 6px 20px rgba(220, 38, 38, 0.4)';
            });

            clearButton.addEventListener('mouseleave', () => {
                clearButton.style.background = 'rgba(220, 38, 38, 0.9)';
                clearButton.style.transform = 'translateY(0)';
                clearButton.style.boxShadow = '0 4px 12px rgba(220, 38, 38, 0.3)';
            });

            // Ê∑ªÂä†ÈªûÊìä‰∫ã‰ª∂
            clearButton.addEventListener('click', () => {
                if (confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÁÄèË¶ΩË®òÈåÑÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ')) {
                    clearAllHistory();
                }
            });

            document.body.appendChild(clearButton);
        }

        // Ê∏ÖÈô§ÊâÄÊúâÁÄèË¶ΩË®òÈåÑ
        function clearAllHistory() {
            historyData = [];
            localStorage.removeItem('viewHistory');
            updateSidebarCounts();

            // ÁßªÈô§Ê∏ÖÈô§ÊåâÈàï
            removeHistoryClearButton();

            // È°ØÁ§∫Á©∫ÁãÄÊÖã
            renderEmptyHistory();
            showSuccessMessage('ÊâÄÊúâÁÄèË¶ΩË®òÈåÑÂ∑≤Ê∏ÖÈô§');
        }

        // ÁßªÈô§ÁÄèË¶ΩË®òÈåÑÊ∏ÖÈô§ÊåâÈàï
        function removeHistoryClearButton() {
            const clearButton = document.getElementById('historyClearButton');
            if (clearButton) {
                clearButton.remove();
            }
        }

        // ÈñãÂïüÂΩàÁ™ó
        async function openModal(coupon) {
            try {
                // Ê∑ªÂä†Âà∞ÁÄèË¶ΩË®òÈåÑ
                addToHistory(coupon);

                // ÂÖàÈ°ØÁ§∫Âü∫Êú¨Ë≥áË®ä
                const webp = coupon.image.replace(/\.jpg$/i, '.webp');
                document.getElementById('modalSourceWebp').srcset = webp;
                const modalImg = document.getElementById('modalImage');
                modalImg.src = coupon.image;
                currentCoupon = coupon;
                document.getElementById('storeName').textContent = coupon.storeName;
                document.getElementById('storeCategory').textContent = coupon.category;
                document.getElementById('offerTitle').textContent = coupon.title;
                document.getElementById('offerDescription').textContent = coupon.description;
                document.getElementById('offerExpiry').textContent = coupon.expiry;
                document.getElementById('offerUsage').textContent = coupon.usage;
                document.getElementById('storeAddress').textContent = coupon.address;
                document.getElementById('storePhone').textContent = coupon.phone;

                // ÂæûAPIÁç≤ÂèñÊõ¥Ë©≥Á¥∞ÁöÑË≥áË®ä
                const res = await fetch(`api/coupons/${coupon.id}`);
                if (res.ok) {
                    const data = await res.json();
                    const detailedCoupon = data.data || data;

                    // Êõ¥Êñ∞Ë©≥Á¥∞Ë≥áË®ä
                    if (detailedCoupon.terms) {
                        document.getElementById('offerDescription').textContent = detailedCoupon.terms;
                    }
                    if (detailedCoupon.discount_type && detailedCoupon.discount_value) {
                        const discountText = getDiscountText(detailedCoupon.discount_type, detailedCoupon.discount_value);
                        document.getElementById('offerUsage').textContent = discountText;
                    }

                    // Êõ¥Êñ∞ÁÄèË¶ΩÊï∏ÔºàÂ¶ÇÊûúÊúâÁöÑË©±Ôºâ
                    if (detailedCoupon.view_count !== undefined) {
                        incrementViewCount(coupon.id);
                    }
                }
            } catch (e) {
                console.warn('ÁÑ°Ê≥ïËºâÂÖ•Ë©≥Á¥∞ÂÑ™ÊÉ†Âà∏Ë≥áË®ä:', e);
            }

            // ÂêåÊ≠•ÂΩàÁ™óÊî∂ËóèÊåâÈàïÊñáÂ≠ó
            syncModalFavoriteButton();

            document.getElementById('modalOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';

            // Á∂ÅÂÆöÁáàÁÆ±ÈñãÂïü
            modalImg.onclick = () => openLightbox(modalImg.currentSrc || modalImg.src);
            // Ë®òÈåÑÁÄèË¶ΩÊ≠∑Âè≤
            addHistory(coupon.id);
        }

        // ËºîÂä©ÂáΩÊï∏ÔºöÊ†ºÂºèÂåñÊäòÊâ£ÊñáÂ≠ó
        function getDiscountText(type, value) {
            switch (type) {
                case 'percentage': return `${value}% ÊäòÊâ£`;
                case 'fixed': return `ÊäòÊâ£ NT$${value}`;
                case 'bogo': return 'Ë≤∑‰∏ÄÈÄÅ‰∏Ä';
                case 'free': return 'ÂÖçË≤ªÈ´îÈ©ó';
                default: return 'ÊØè‰∫∫ÈôêÁî®‰∏ÄÊ¨°';
            }
        }

        // Â¢ûÂä†ÁÄèË¶ΩÊï∏ÔºàÈùúÈªòÊõ¥Êñ∞Ôºâ
        async function incrementViewCount(couponId) {
            try {
                await fetch(`api/coupons/${couponId}/view`, { method: 'POST' });
            } catch (e) {
                // ÈùúÈªòÂ§±Êïó
            }
        }

        function syncModalFavoriteButton() {
            const favs = new Set(getFavorites());
            const isFav = currentCoupon ? favs.has(currentCoupon.id) : false;
            const btn = document.querySelector('#modalOverlay .btn-secondary');
            if (btn) {
                btn.textContent = isFav ? 'ÂèñÊ∂àÊî∂Ëóè' : 'Êî∂ËóèÂÑ™ÊÉ†';
            }
        }

        function toggleFavoriteFromModal() {
            if (currentCoupon) {
                toggleFavorite(currentCoupon);
                syncModalFavoriteButton();
            }
        }

        // ÂÑ™ÊÉ†Âà∏‰ΩøÁî®ÂäüËÉΩ
        async function useCoupon(coupon) {
            if (!coupon) return;

            if (!isLoggedIn()) {
                showSuccessMessage('Ë´ãÂÖàÁôªÂÖ•ÊâçËÉΩ‰ΩøÁî®ÂÑ™ÊÉ†Âà∏');
                closeModal();
                // ÂèØ‰ª•ÈñãÂïüÁôªÂÖ•Ë¶ñÁ™ó
                return;
            }

            // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ì‰ΩøÁî®ÈÅé
            const usedCoupons = getUsedCoupons();
            if (usedCoupons.includes(coupon.id)) {
                showSuccessMessage('ÊÇ®Â∑≤Á∂ì‰ΩøÁî®ÈÅéÈÄôÂºµÂÑ™ÊÉ†Âà∏‰∫Ü');
                return;
            }

            // Á¢∫Ë™ç‰ΩøÁî®ÂÑ™ÊÉ†Âà∏
            const confirmModal = document.createElement('div');
            confirmModal.className = 'modal-overlay';
            confirmModal.style.cssText = 'display: flex; z-index: 10001;';

            confirmModal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div style="padding: 28px; text-align: center;">
                        <h3 style="margin-bottom: 16px; color: #374151;">üé´ ‰ΩøÁî®ÂÑ™ÊÉ†Âà∏</h3>
                        <p style="margin-bottom: 20px; color: #6b7280;">
                            Á¢∫ÂÆöË¶Å‰ΩøÁî®„Äå${coupon.title}„ÄçÂóéÔºü<br>
                            ‰ΩøÁî®ÂæåÂ∞áÁÑ°Ê≥ïÂÜçÊ¨°‰ΩøÁî®Ê≠§ÂÑ™ÊÉ†Âà∏„ÄÇ
                        </p>
                        <div style="display: flex; gap: 12px;">
                            <button onclick="cancelUseCoupon()" class="btn-secondary" style="flex: 1;">ÂèñÊ∂à</button>
                            <button onclick="confirmUseCoupon(${coupon.id})" class="btn-primary" style="flex: 1;">Á¢∫Ë™ç‰ΩøÁî®</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(confirmModal);
            document.body.style.overflow = 'hidden';

            // Ê∑ªÂä†ÈªûÊìäËÉåÊôØÈóúÈñâÂäüËÉΩ
            addClickOutsideToClose(confirmModal, cancelUseCoupon);
        }

        function cancelUseCoupon() {
            const modal = document.querySelector('.modal-overlay:last-child');
            if (modal) {
                modal.remove();
                document.body.style.overflow = 'auto';
            }
        }

        async function confirmUseCoupon(couponId) {
            try {
                // Ë™øÁî®APIË®òÈåÑ‰ΩøÁî®
                const response = await fetch(`api/coupons/${couponId}/use`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();

                    // Ë®òÈåÑÂà∞Êú¨Âú∞Â≠òÂÑ≤
                    const usedCoupons = getUsedCoupons();
                    usedCoupons.push(couponId);
                    setUsedCoupons(usedCoupons);

                    // ÈóúÈñâÊâÄÊúâÂΩàÁ™ó
                    cancelUseCoupon();
                    closeModal();

                    // È°ØÁ§∫ÊàêÂäüË®äÊÅØ
                    showSuccessMessage('üéâ ÂÑ™ÊÉ†Âà∏‰ΩøÁî®ÊàêÂäüÔºÅË´ãÂêëÂ∫óÂÆ∂Âá∫Á§∫Ê≠§ÊÜëË≠â');

                    // ÁîüÊàê‰ΩøÁî®ÊÜëË≠âÔºàÂåÖÂê´QR CodeÔºâ
                    generateUsageProof(currentCoupon, result);
                } else {
                    throw new Error('‰ΩøÁî®ÂÑ™ÊÉ†Âà∏Â§±Êïó');
                }
            } catch (e) {
                console.error('‰ΩøÁî®ÂÑ™ÊÉ†Âà∏Â§±Êïó:', e);
                showSuccessMessage('‰ΩøÁî®Â§±ÊïóÔºö' + e.message);
            }
        }

        function generateUsageProof(coupon, usageResult = {}) {
            const proofModal = document.createElement('div');
            proofModal.className = 'modal-overlay';
            proofModal.style.cssText = 'display: flex; z-index: 10002; background: rgba(0,0,0,0.8);';

            const verificationCode = usageResult.verification_code || `SHK-${coupon.id}-${Date.now().toString().slice(-6)}`;
            const qrCodeUrl = usageResult.qr_code_url || '';
            const expiresAt = usageResult.expires_at || '';

            proofModal.innerHTML = `
                <div class="modal-content" style="max-width: 450px; background: linear-gradient(135deg, #FCA311, #F79009); color: white; border: none;">
                    <button onclick="closeUsageProof()" style="position: absolute; top: 10px; right: 15px; background: none; border: none; color: white; font-size: 24px; cursor: pointer;">√ó</button>
                    <div style="padding: 40px 28px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üé´</div>
                        <h3 style="margin-bottom: 12px;">ÂÑ™ÊÉ†Âà∏‰ΩøÁî®ÊÜëË≠â</h3>
                        
                        <div style="background: rgba(255,255,255,0.2); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                            <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">${coupon.title}</div>
                            <div style="font-size: 14px; opacity: 0.9;">${coupon.storeName || coupon.vendor_name || 'Â∫óÂÆ∂ÂêçÁ®±'}</div>
                        </div>
                        
                        ${qrCodeUrl ? `
                        <div style="background: white; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                            <img src="${qrCodeUrl}" alt="QR Code" style="width: 200px; height: 200px; display: block; margin: 0 auto;">
                            <div style="font-size: 12px; color: #666; margin-top: 8px;">Ë´ãÂêëÂ∫óÂÆ∂Âá∫Á§∫Ê≠§QR Code</div>
                        </div>
                        ` : ''}
                        
                        <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                            <div style="font-size: 12px; opacity: 0.8; margin-bottom: 4px;">È©óË≠âÁ¢º</div>
                            <div style="font-size: 18px; font-weight: 700; letter-spacing: 1px;">${verificationCode}</div>
                        </div>
                        
                        ${expiresAt ? `
                        <div style="font-size: 12px; opacity: 0.8; margin-bottom: 16px;">
                            ÊÜëË≠âÊúâÊïàÊúüËá≥Ôºö${new Date(expiresAt).toLocaleString('zh-TW')}
                        </div>
                        ` : ''}
                        <div style="font-size: 12px; opacity: 0.8;">
                            ‰ΩøÁî®ÊôÇÈñìÔºö${now.toLocaleString('zh-TW')}<br>
                            Ë´ãÂêëÂ∫óÂÆ∂Âá∫Á§∫Ê≠§ÊÜëË≠â
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(proofModal);

            // Ê∑ªÂä†ÈªûÊìäËÉåÊôØÈóúÈñâÂäüËÉΩ
            addClickOutsideToClose(proofModal, closeUsageProof);
        }

        function closeUsageProof() {
            const modal = document.querySelector('.modal-overlay:last-child');
            if (modal) {
                modal.remove();
                document.body.style.overflow = 'auto';
            }
        }

        // ‰ΩøÁî®Ë®òÈåÑÁÆ°ÁêÜ
        function getUsedCoupons() {
            try {
                return JSON.parse(localStorage.getItem('usedCoupons') || '[]');
            } catch {
                return [];
            }
        }

        function setUsedCoupons(list) {
            localStorage.setItem('usedCoupons', JSON.stringify(list));
        }

        // ÈóúÈñâÂΩàÁ™ó
        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // ÁáàÁÆ±ÂäüËÉΩ
        function openLightbox(src) {
            const overlay = document.getElementById('lightboxOverlay');
            const img = document.getElementById('lightboxImage');
            img.src = src;
            overlay.style.display = 'flex';
        }
        function closeLightbox() {
            const overlay = document.getElementById('lightboxOverlay');
            overlay.style.display = 'none';
        }

        // Êî∂ËóèËàáÊ≠∑Âè≤ÔºàÊú¨Âú∞Ôºâ
        function getFavorites() { try { return JSON.parse(localStorage.getItem(LS_FAVORITES) || '[]'); } catch { return []; } }
        function setFavorites(list) { localStorage.setItem(LS_FAVORITES, JSON.stringify(list)); }
        function isFav(id) { return getFavorites().includes(id); }
        async function toggleFavorite(coupon) {
            if (isLoggedIn()) {
                try {
                    const token = getToken();
                    const favIds = new Set(getFavorites());
                    const isFavNow = favIds.has(coupon.id);
                    if (isFavNow) {
                        await fetch(`api/favorites/${coupon.id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                        favIds.delete(coupon.id);
                    } else {
                        await fetch('api/favorites', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ coupon_id: coupon.id }) });
                        favIds.add(coupon.id);
                    }
                    setFavorites(Array.from(favIds));
                    // Êõ¥Êñ∞ÂÅ¥ÈÇäÊ¨ÑË®àÊï∏
                    updateSidebarCounts();
                    // ‰∏çÂÜçË∑≥Âá∫ alertÔºå‰ΩøÁî®ÈùúÈªòÊõ¥Êñ∞ËàáÊÑõÂøÉÂàáÊèõ
                } catch (e) {
                    console.warn('ÂêåÊ≠•Êî∂ËóèÂ§±Êïó');
                }
            } else {
                const favs = getFavorites();
                const idx = favs.indexOf(coupon.id);
                if (idx >= 0) { favs.splice(idx, 1); } else { favs.unshift(coupon.id); }
                setFavorites(favs.slice(0, 200));
                // Êõ¥Êñ∞ÂÅ¥ÈÇäÊ¨ÑË®àÊï∏
                updateSidebarCounts();
                // ‰∏çÂÜçË∑≥Âá∫ alert
            }
            // ÂêåÊ≠•ÊâÄÊúâÊÑõÂøÉ„ÄÅÊî∂ËóèÊï∏ËàáÊî∂ËóèË¶ñÂúñ
            const nowActive = isFav(coupon.id);
            document.querySelectorAll(`[data-action="quick-fav"][data-id="${coupon.id}"]`).forEach(btn => {
                btn.classList.toggle('active', nowActive);
                btn.textContent = nowActive ? '‚ù§' : '‚ô°';
            });
            updateFavCount();
            syncModalFavoriteButton();
            if (isFavoritesView() && !nowActive) {
                const card = document.querySelector(`.coupon-card[data-id="${coupon.id}"]`);
                if (card) card.remove();
                if (document.querySelectorAll('.coupon-card').length === 0) renderEmptyFavorites();
            }
        }

        function getHistory() { try { return JSON.parse(localStorage.getItem(LS_HISTORY) || '[]'); } catch { return []; } }
        function setHistory(list) { localStorage.setItem(LS_HISTORY, JSON.stringify(list)); }
        function addHistory(id) { const h = getHistory().filter(x => x !== id); h.unshift(id); setHistory(h.slice(0, 200)); }

        // Ê∑ªÂä†Ê®ôÁ±§
        function addTag(tagText, tagType = 'search') {
            // Ê™¢Êü•ÊòØÂê¶Â∑≤Â≠òÂú®
            if (selectedTags.some(tag => tag.text === tagText)) {
                return;
            }

            selectedTags.push({ text: tagText, type: tagType });
            renderSelectedTags();
            performSearch();
        }

        // ÁßªÈô§Ê®ôÁ±§
        function removeTag(tagText) {
            selectedTags = selectedTags.filter(tag => tag.text !== tagText);
            renderSelectedTags();
            performSearch();

            // Êõ¥Êñ∞‰∏ãÊãâÈÅ∏ÂñÆ‰∏≠ÁöÑÈÅ∏‰∏≠ÁãÄÊÖã
            updateDropdownSelection();
        }

        // Ê∏≤ÊüìÈÅ∏‰∏≠ÁöÑÊ®ôÁ±§
        function renderSelectedTags() {
            const container = document.getElementById('selectedTags');
            container.innerHTML = '';

            selectedTags.forEach(tag => {
                const tagElement = document.createElement('div');
                tagElement.className = 'selected-tag';
                tagElement.innerHTML = `
                     <span>${tag.text}</span>
                     <button class="selected-tag-remove" onclick="removeTag('${tag.text}')">√ó</button>
                 `;
                container.appendChild(tagElement);
            });

            // Êõ¥Êñ∞ÊêúÂ∞ãÊ°Ü placeholder
            const searchInput = document.getElementById('searchInput');
            if (selectedTags.length > 0) {
                searchInput.placeholder = 'ÁπºÁ∫åÊêúÂ∞ã...';
            } else {
                searchInput.placeholder = 'ÊêúÂ∞ãÂÑ™ÊÉ†Âà∏„ÄÅÂ∫óÂÆ∂ÊàñÂàÜÈ°û...';
            }
        }

        // Êõ¥Êñ∞‰∏ãÊãâÈÅ∏ÂñÆ‰∏≠ÁöÑÈÅ∏‰∏≠ÁãÄÊÖã
        function updateDropdownSelection() {
            // Êõ¥Êñ∞ÂàÜÈ°ûÊ®ôÁ±§ÈÅ∏‰∏≠ÁãÄÊÖã
            document.querySelectorAll('.category-chip').forEach(chip => {
                const category = chip.getAttribute('data-category');
                const isSelected = selectedTags.some(tag => tag.text.includes(category));
                chip.classList.toggle('selected', isSelected);
            });

            // Êõ¥Êñ∞ÁÜ±ÈñÄÊ®ôÁ±§ÈÅ∏‰∏≠ÁãÄÊÖã
            document.querySelectorAll('.trending-tag').forEach(tag => {
                const tagText = tag.getAttribute('data-tag');
                const isSelected = selectedTags.some(tag => tag.text === tagText);
                tag.classList.toggle('selected', isSelected);
            });
        }

        // Âü∑Ë°åÊêúÂ∞ã (ÁµêÂêàÊ®ôÁ±§ÂíåËº∏ÂÖ•Ê°Ü)
        async function performSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput.value.toLowerCase().trim();

            // Â¶ÇÊûúÊúâÊêúÂ∞ãË©ûÔºåÂòóË©¶ÂæûAPIÊêúÂ∞ã
            if (searchTerm !== '') {
                try {
                    const res = await fetch(`api/coupons?search=${encodeURIComponent(searchTerm)}&page=1&pageSize=50`);
                    const json = await res.json();
                    const items = json?.data?.coupons || [];

                    if (Array.isArray(items) && items.length > 0) {
                        // ËΩâÊèõAPIË≥áÊñôÊ†ºÂºè
                        const searchResults = items.map((item, idx) => ({
                            id: item.id || idx + 1,
                            image: item.image && item.image.trim() !== '' ? item.image : `img/ÈÄÅÂ•ΩÂ∫∑ÊñáÂÆ£Á¥†Êùê (${(idx % 50) + 1}).jpg`,
                            storeName: item.storeName || 'Âêà‰ΩúÂ∫óÂÆ∂',
                            category: item.category || '‰∏ÄËà¨ÂÑ™ÊÉ†',
                            title: item.title || 'ÂÑ™ÊÉ†Ê¥ªÂãï',
                            discount: item.discount_value ? `${item.discount_value}${item.discount_type === 'percentage' ? '%' : 'ÂÖÉ'} OFF` : 'ÁâπÂÉπÂÑ™ÊÉ†',
                            expiry: item.end_date ? new Date(item.end_date).toLocaleDateString('zh-TW') : '',
                            usage: item.usage_rules || 'ÊØè‰∫∫ÈôêÁî®‰∏ÄÊ¨°',
                            description: item.description || 'Ë©≥ÊÉÖË´ãË¶ãÊ¥ªÂãïË™™Êòé„ÄÇ',
                            address: item.address || '',
                            phone: item.phone || ''
                        }));

                        renderCoupons(searchResults);
                        return;
                    }
                } catch (e) {
                    console.warn('APIÊêúÂ∞ãÂ§±ÊïóÔºå‰ΩøÁî®Êú¨Âú∞ÊêúÂ∞ã:', e);
                }
            }

            // ÂõûÈÄÄÂà∞Êú¨Âú∞ÊêúÂ∞ã
            let filteredCoupons = coupons;

            // Ê†πÊìöÈÅ∏‰∏≠ÁöÑÊ®ôÁ±§ÁØ©ÈÅ∏
            if (selectedTags.length > 0) {
                filteredCoupons = coupons.filter(coupon => {
                    return selectedTags.some(tag => {
                        if (tag.type === 'category') {
                            return coupon.category.includes(tag.text);
                        } else {
                            return coupon.storeName.toLowerCase().includes(tag.text.toLowerCase()) ||
                                coupon.title.toLowerCase().includes(tag.text.toLowerCase()) ||
                                coupon.category.toLowerCase().includes(tag.text.toLowerCase());
                        }
                    });
                });
            }

            // ÂÜçÊ†πÊìöÊêúÂ∞ãÊ°ÜÂÖßÂÆπÈÄ≤‰∏ÄÊ≠•ÁØ©ÈÅ∏
            if (searchTerm !== '') {
                filteredCoupons = filteredCoupons.filter(coupon =>
                    coupon.storeName.toLowerCase().includes(searchTerm) ||
                    coupon.title.toLowerCase().includes(searchTerm) ||
                    coupon.category.toLowerCase().includes(searchTerm)
                );
            }

            renderCoupons(filteredCoupons);
        }

        // ÊêúÂ∞ãÂäüËÉΩ (‰øùÁïôÂéüÊúâÂäüËÉΩÔºå‰ΩÜÊîπÁÇ∫Ë™øÁî® performSearch)
        function handleSearch() {
            performSearch();
        }

        // ÂàÜÈ°ûÁØ©ÈÅ∏
        function filterByCategory(category) {
            const filteredCoupons = coupons.filter(coupon =>
                coupon.category.includes(category)
            );
            renderCoupons(filteredCoupons);
            document.getElementById('searchDropdown').classList.remove('active');

            // Êõ¥Êñ∞ÂÅ¥ÈÇäÊ¨ÑÈÅ∏‰∏≠ÁãÄÊÖã
            updateSidebarSelection(category);
        }

        // ÈáçÁΩÆÂõûÈ¶ñÈ†Å
        function resetToHomepage() {
            setView('home');
            // Ê∏ÖÁ©∫ÊêúÂ∞ãÊ°Ü
            document.getElementById('searchInput').value = '';

            // Ê∏ÖÁ©∫ÊâÄÊúâÈÅ∏‰∏≠ÁöÑÊ®ôÁ±§
            selectedTags = [];
            renderSelectedTags();

            // ÈóúÈñâÊêúÂ∞ã‰∏ãÊãâÈÅ∏ÂñÆ
            document.getElementById('searchDropdown').classList.remove('active');

            // Êõ¥Êñ∞‰∏ãÊãâÈÅ∏ÂñÆÈÅ∏‰∏≠ÁãÄÊÖã
            updateDropdownSelection();

            // ÈáçÊñ∞Ê∏≤ÊüìÊâÄÊúâÂÑ™ÊÉ†Âà∏
            renderCoupons(coupons);

            // ÈáçÁΩÆÂÅ¥ÈÇäÊ¨ÑÈÅ∏‰∏≠ÁãÄÊÖãÁÇ∫È¶ñÈ†Å
            updateSidebarSelection('È¶ñÈ†Å');

            // ÊªæÂãïÂà∞È†ÇÈÉ®
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Êõ¥Êñ∞ÂÅ¥ÈÇäÊ¨ÑÈÅ∏‰∏≠ÁãÄÊÖã
        function updateSidebarSelection(activeItem) {
            // ÁßªÈô§ÊâÄÊúâactiveÁãÄÊÖã
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });

            // Ê†πÊìöactiveItemË®≠ÂÆöÊñ∞ÁöÑactiveÁãÄÊÖã
            let targetItem = null;

            document.querySelectorAll('.sidebar-item').forEach(item => {
                const text = item.querySelector('.sidebar-text')?.textContent;

                if (activeItem === 'È¶ñÈ†Å' && text === 'È¶ñÈ†Å') {
                    targetItem = item;
                }
            });

            if (targetItem) {
                targetItem.classList.add('active');
            }
        }

        // ÂÅ¥ÈÇäÊ¨ÑÂ±ïÈñã/Êî∂Ëµ∑ÂäüËÉΩ
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('expanded');
        }

        // Ëá™ÂãïÂ±ïÈñã/Êî∂Ëµ∑ÂÅ¥ÈÇäÊ¨Ñ
        function setupSidebarToggle() {
            const sidebar = document.querySelector('.sidebar');
            const header = document.querySelector('.header');
            const mainContent = document.querySelector('.main-content');
            let hoverTimer;

            function expandSidebar() {
                sidebar.classList.add('expanded');
                header.classList.add('pushed');
                mainContent.classList.add('pushed');
            }

            function collapseSidebar() {
                sidebar.classList.remove('expanded');
                header.classList.remove('pushed');
                mainContent.classList.remove('pushed');
            }

            // ÊªëÈº†ÈÄ≤ÂÖ•ÊôÇÂ±ïÈñã
            sidebar.addEventListener('mouseenter', () => {
                clearTimeout(hoverTimer);
                expandSidebar();
            });

            // ÊªëÈº†Èõ¢ÈñãÊôÇÊî∂Ëµ∑ÔºàÂª∂ÈÅ≤300msÔºâ
            sidebar.addEventListener('mouseleave', () => {
                hoverTimer = setTimeout(() => {
                    collapseSidebar();
                }, 300);
            });

            // ÈªûÊìäÈ†ÖÁõÆÊôÇ‰øùÊåÅÂ±ïÈñãÁãÄÊÖã‰∏ÄÊÆµÊôÇÈñì
            sidebar.addEventListener('click', () => {
                clearTimeout(hoverTimer);
                expandSidebar();

                // 3ÁßíÂæåËá™ÂãïÊî∂Ëµ∑
                hoverTimer = setTimeout(() => {
                    collapseSidebar();
                }, 3000);
            });
        }

        // ÂÅ¥ÈÇäÊ¨ÑÂäüËÉΩÂØ¶Áèæ
        let currentSidebarView = 'home';
        let historyData = JSON.parse(localStorage.getItem('viewHistory') || '[]');

        // Êõ¥Êñ∞ÂÅ¥ÈÇäÊ¨ÑË®àÊï∏
        function updateSidebarCounts() {
            // ÈáçÊñ∞Âæû localStorage ËºâÂÖ•ÁÄèË¶ΩË®òÈåÑÔºåÁ¢∫‰øùÊï∏ÊìöÂêåÊ≠•
            historyData = JSON.parse(localStorage.getItem('viewHistory') || '[]');

            // Ê∏ÖÁêÜÁÑ°ÊïàÁöÑÁÄèË¶ΩË®òÈåÑ
            if (coupons && coupons.length > 0) {
                const validHistoryData = historyData.filter(item =>
                    coupons.some(coupon => coupon.id === item.id)
                );

                if (validHistoryData.length !== historyData.length) {
                    historyData = validHistoryData;
                    localStorage.setItem('viewHistory', JSON.stringify(historyData));
                }
            }

            // Êî∂ËóèÊï∏Èáè
            const favCount = getFavorites().length;
            const favCountEl = document.getElementById('favCount');
            if (favCount > 0) {
                favCountEl.textContent = favCount;
                favCountEl.style.display = 'inline-block';
            } else {
                favCountEl.style.display = 'none';
            }

            // ÁÄèË¶ΩË®òÈåÑÊï∏Èáè
            const historyCountEl = document.getElementById('historyCount');
            console.log('ÁÄèË¶ΩË®òÈåÑÊï∏Êìö:', historyData); // Ë™øË©¶Áî®

            if (historyData.length > 0) {
                historyCountEl.textContent = historyData.length > 99 ? '99+' : historyData.length;
                historyCountEl.style.display = 'inline-block';
            } else {
                historyCountEl.style.display = 'none';
            }

            // ÂêåÊôÇÊõ¥Êñ∞ÊúÉÂì°ÈÅ∏ÂñÆÁöÑÂæΩÁ´†
            if (isLoggedIn()) {
                updateSimpleMemberMenuBadges();
            }
        }

        // Ë®≠ÂÆöÂÅ¥ÈÇäÊ¨ÑÊ¥ªÂãïÁãÄÊÖã
        function setSidebarActive(action) {
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            const activeItem = document.querySelector(`[data-action="${action}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
            currentSidebarView = action;
        }

        // ÂÅ¥ÈÇäÊ¨ÑÂäüËÉΩËôïÁêÜ
        function handleSidebarAction(action) {
            setSidebarActive(action);

            switch (action) {
                case 'home':
                    showAllCoupons();
                    break;
                case 'favorites':
                    showFavorites();
                    break;
                case 'history':
                    showHistory();
                    break;
                case 'hot':
                    showHotCoupons();
                    break;
                case 'nearby':
                    showNearbyCoupons();
                    break;
                case 'limited':
                    showLimitedCoupons();
                    break;
                case 'settings':
                    showSettings();
                    break;
                case 'help':
                    showHelp();
                    break;
            }
        }

        // È°ØÁ§∫ÊâÄÊúâÂÑ™ÊÉ†Âà∏ÔºàÈ¶ñÈ†ÅÔºâ
        function showAllCoupons() {
            setView('home');
            removeHistoryClearButton(); // ÁßªÈô§Ê∏ÖÈô§ÊåâÈàï
            renderCoupons(coupons);
            showSuccessMessage('ÂõûÂà∞È¶ñÈ†Å');
        }

        // È°ØÁ§∫Êî∂ËóèÂàóË°®
        async function showFavorites() {
            removeHistoryClearButton(); // ÁßªÈô§Ê∏ÖÈô§ÊåâÈàï
            await viewFavorites(); // ‰ΩøÁî®ÁèæÊúâÁöÑÊî∂ËóèÂäüËÉΩ
        }

        // È°ØÁ§∫ÁÄèË¶ΩË®òÈåÑ
        function showHistory() {
            const historyIds = historyData.map(item => item.id);
            const historyCoupons = coupons.filter(coupon => historyIds.includes(coupon.id));

            // Ê∏ÖÁêÜÁÑ°ÊïàÁöÑÁÄèË¶ΩË®òÈåÑÔºàÂÑ™ÊÉ†Âà∏Â∑≤‰∏çÂ≠òÂú®Ôºâ
            const validHistoryData = historyData.filter(item =>
                coupons.some(coupon => coupon.id === item.id)
            );

            // Â¶ÇÊûúÊúâÁÑ°ÊïàË®òÈåÑË¢´Ê∏ÖÁêÜÔºåÊõ¥Êñ∞ localStorage
            if (validHistoryData.length !== historyData.length) {
                historyData = validHistoryData;
                localStorage.setItem('viewHistory', JSON.stringify(historyData));
                updateSidebarCounts(); // Êõ¥Êñ∞Ë®àÊï∏
            }

            // Â¶ÇÊûúÊ≤íÊúâÁÄèË¶ΩË®òÈåÑÔºåÈ°ØÁ§∫Á©∫ÁãÄÊÖã
            if (historyData.length === 0) {
                renderEmptyHistory();
                showSuccessMessage('ÁõÆÂâçÊ≤íÊúâÁÄèË¶ΩË®òÈåÑ');
                return;
            }

            // ÊåâÁÄèË¶ΩÊôÇÈñìÊéíÂ∫èÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÔºâ
            const sortedHistory = historyCoupons.sort((a, b) => {
                const aTime = historyData.find(h => h.id === a.id)?.timestamp || 0;
                const bTime = historyData.find(h => h.id === b.id)?.timestamp || 0;
                return bTime - aTime;
            });

            // Âú®È†ÅÈù¢È†ÇÈÉ®Ê∑ªÂä†Ê∏ÖÈô§ÊåâÈàï
            addHistoryClearButton();
            renderCoupons(sortedHistory);
            showSuccessMessage(`È°ØÁ§∫ ${sortedHistory.length} ÂÄãÁÄèË¶ΩË®òÈåÑ`);
        }

        // È°ØÁ§∫ÁÜ±ÈñÄÂÑ™ÊÉ†
        function showHotCoupons() {
            removeHistoryClearButton(); // ÁßªÈô§Ê∏ÖÈô§ÊåâÈàï
            // ÊåâÁÄèË¶ΩÊ¨°Êï∏ÊéíÂ∫è
            const hotCoupons = [...coupons].sort((a, b) => (b.view_count || 0) - (a.view_count || 0));
            renderCoupons(hotCoupons);

            // Êõ¥Êñ∞Ë®àÊï∏
            const hotCountEl = document.getElementById('hotCount');
            hotCountEl.textContent = hotCoupons.length;
            hotCountEl.style.display = 'inline-block';

            showSuccessMessage('È°ØÁ§∫ÁÜ±ÈñÄÂÑ™ÊÉ†');
        }

        // È°ØÁ§∫ÈôÑËøëÂÑ™ÊÉ†ÔºàÊ®°Êì¨Âú∞ÁêÜ‰ΩçÁΩÆÔºâ
        function showNearbyCoupons() {
            removeHistoryClearButton(); // ÁßªÈô§Ê∏ÖÈô§ÊåâÈàï
            // Ê®°Êì¨ÈôÑËøëÂÑ™ÊÉ†ÔºàÈö®Ê©üÈÅ∏Êìá‰∏Ä‰∫õÂÑ™ÊÉ†Âà∏Ôºâ
            const nearbyCount = Math.min(10, coupons.length);
            const shuffled = [...coupons].sort(() => 0.5 - Math.random());
            const nearbyCoupons = shuffled.slice(0, nearbyCount);

            renderCoupons(nearbyCoupons);

            // Êõ¥Êñ∞Ë®àÊï∏
            const nearbyCountEl = document.getElementById('nearbyCount');
            nearbyCountEl.textContent = nearbyCount;
            nearbyCountEl.style.display = 'inline-block';

            showSuccessMessage(`ÊâæÂà∞ ${nearbyCount} ÂÄãÈôÑËøëÂÑ™ÊÉ†`);
        }

        // È°ØÁ§∫ÈôêÊôÇÊ¥ªÂãï
        function showLimitedCoupons() {
            removeHistoryClearButton(); // ÁßªÈô§Ê∏ÖÈô§ÊåâÈàï
            const now = new Date();
            const oneWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);

            const limitedCoupons = coupons.filter(coupon => {
                if (!coupon.expiry) return false;
                const expiryDate = new Date(coupon.expiry);
                return expiryDate <= oneWeek && expiryDate > now;
            });

            renderCoupons(limitedCoupons);

            // Êõ¥Êñ∞Ë®àÊï∏
            const limitedCountEl = document.getElementById('limitedCount');
            limitedCountEl.textContent = limitedCoupons.length;
            limitedCountEl.style.display = 'inline-block';

            showSuccessMessage(`ÊâæÂà∞ ${limitedCoupons.length} ÂÄãÈôêÊôÇÊ¥ªÂãï`);
        }

        // È°ØÁ§∫Ë®≠ÂÆöÈù¢Êùø
        function showSettings() {
            const settingsModal = document.createElement('div');
            settingsModal.className = 'modal-overlay';
            settingsModal.style.cssText = 'display: flex; z-index: 10000;';

            settingsModal.innerHTML = `
                <div class="modal-content profile-modal-content">
                    <button class="modal-close" onclick="closeSettings()">√ó</button>
                    <div class="profile-modal-body">
                        <div class="profile-header">
                            <div class="profile-avatar">‚öôÔ∏è</div>
                            <h2 class="profile-title">Á≥ªÁµ±Ë®≠ÂÆö</h2>
                        </div>
                        
                        <!-- È°ØÁ§∫Ë®≠ÂÆö -->
                        <div class="profile-section">
                            <h3 class="section-title">È°ØÁ§∫Ë®≠ÂÆö</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">
                                        <input type="checkbox" id="showCounts" style="margin-right: 8px;">
                                        È°ØÁ§∫ÂÅ¥ÈÇäÊ¨ÑË®àÊï∏
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        <input type="checkbox" id="autoExpand" style="margin-right: 8px;">
                                        Ëá™ÂãïÂ±ïÈñãÂÅ¥ÈÇäÊ¨Ñ
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Êï∏ÊìöË®≠ÂÆö -->
                        <div class="profile-section">
                            <h3 class="section-title">Êï∏ÊìöÁÆ°ÁêÜ</h3>
                            <div class="form-grid">
                                <button class="btn-secondary" onclick="clearHistory()" style="margin-bottom: 10px;">
                                    Ê∏ÖÈô§ÁÄèË¶ΩË®òÈåÑ
                                </button>
                                <button class="btn-secondary" onclick="clearSearchHistory()" style="margin-bottom: 10px;">
                                    Ê∏ÖÈô§ÊêúÂ∞ãË®òÈåÑ
                                </button>
                                <button class="btn-secondary" onclick="exportData()">
                                    ÂåØÂá∫ÊàëÁöÑË≥áÊñô
                                </button>
                            </div>
                        </div>
                        
                        <div class="profile-actions">
                            <button onclick="closeSettings()" class="btn-secondary">ÈóúÈñâ</button>
                            <button onclick="saveSettings()" class="btn-primary">ÂÑ≤Â≠òË®≠ÂÆö</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(settingsModal);
            document.body.style.overflow = 'hidden';

            // Ê∑ªÂä†ÈªûÊìäËÉåÊôØÈóúÈñâÂäüËÉΩ
            addClickOutsideToClose(settingsModal, closeSettings);

            // ËºâÂÖ•Áï∂ÂâçË®≠ÂÆö
            loadCurrentSettings();
        }

        function closeSettings() {
            const modal = document.querySelector('.modal-overlay:last-child');
            if (modal) {
                modal.remove();
                document.body.style.overflow = 'auto';
            }
        }

        function loadCurrentSettings() {
            const settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
            document.getElementById('showCounts').checked = settings.showCounts !== false;
            document.getElementById('autoExpand').checked = settings.autoExpand === true;
        }

        function saveSettings() {
            const settings = {
                showCounts: document.getElementById('showCounts').checked,
                autoExpand: document.getElementById('autoExpand').checked
            };

            localStorage.setItem('userSettings', JSON.stringify(settings));
            applySettings(settings);
            showSuccessMessage('Ë®≠ÂÆöÂ∑≤ÂÑ≤Â≠ò');
            closeSettings();
        }

        function applySettings(settings) {
            // ÊáâÁî®È°ØÁ§∫Ë®≠ÂÆö
            const countElements = document.querySelectorAll('.sidebar-count');
            countElements.forEach(el => {
                if (settings.showCounts === false) {
                    el.style.display = 'none';
                } else {
                    // ÊÅ¢Âæ©ÂéüÊú¨ÁöÑÈ°ØÁ§∫ÈÇèËºØ
                    const count = parseInt(el.textContent) || 0;
                    el.style.display = count > 0 ? 'inline-block' : 'none';
                }
            });
        }

        function clearHistory() {
            if (confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÁÄèË¶ΩË®òÈåÑÂóéÔºü')) {
                historyData = [];
                localStorage.removeItem('viewHistory');
                updateSidebarCounts();
                showSuccessMessage('ÁÄèË¶ΩË®òÈåÑÂ∑≤Ê∏ÖÈô§');
            }
        }

        function clearSearchHistory() {
            if (confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÊêúÂ∞ãË®òÈåÑÂóéÔºü')) {
                searchHistory = [];
                localStorage.removeItem('searchHistory');
                renderSearchHistory();
                showSuccessMessage('ÊêúÂ∞ãË®òÈåÑÂ∑≤Ê∏ÖÈô§');
            }
        }

        function exportData() {
            const data = {
                favorites: getFavorites(),
                history: historyData,
                searchHistory: searchHistory,
                settings: JSON.parse(localStorage.getItem('userSettings') || '{}')
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ÈÄÅÈΩÅÂ∫∑_ÊàëÁöÑË≥áÊñô.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showSuccessMessage('Ë≥áÊñôÂåØÂá∫ÂÆåÊàê');
        }

        // È°ØÁ§∫Âπ´Âä©‰∏≠ÂøÉ
        function showHelp() {
            const helpModal = document.createElement('div');
            helpModal.className = 'modal-overlay';
            helpModal.style.cssText = 'display: flex; z-index: 10000;';

            helpModal.innerHTML = `
                <div class="modal-content profile-modal-content">
                    <button class="modal-close" onclick="closeHelp()">√ó</button>
                    <div class="profile-modal-body">
                        <div class="profile-header">
                            <div class="profile-avatar">‚ùì</div>
                            <h2 class="profile-title">Âπ´Âä©‰∏≠ÂøÉ</h2>
                        </div>
                        
                        <!-- Â∏∏Ë¶ãÂïèÈ°å -->
                        <div class="profile-section">
                            <h3 class="section-title">Â∏∏Ë¶ãÂïèÈ°å</h3>
                            <div class="help-item">
                                <h4>Â¶Ç‰Ωï‰ΩøÁî®ÂÑ™ÊÉ†Âà∏Ôºü</h4>
                                <p>1. ÈªûÊìäÂÑ™ÊÉ†Âà∏Âç°ÁâáÊü•ÁúãË©≥ÊÉÖ<br>
                                2. ÈªûÊìä„ÄåÁ´ãÂç≥‰ΩøÁî®„ÄçÊåâÈàï<br>
                                3. Á¢∫Ë™ç‰ΩøÁî®ÂæåÊúÉÁîüÊàê‰ΩøÁî®Ë≠âÊòé<br>
                                4. ÂêëÂ∫óÂÆ∂Âá∫Á§∫Ë≠âÊòéÂç≥ÂèØ‰∫´ÂèóÂÑ™ÊÉ†</p>
                            </div>
                            <div class="help-item">
                                <h4>Â¶Ç‰ΩïÊî∂ËóèÂÑ™ÊÉ†Âà∏Ôºü</h4>
                                <p>ÈªûÊìäÂÑ™ÊÉ†Âà∏Âç°ÁâáÂè≥‰∏äËßíÁöÑÊÑõÂøÉÂúñÊ®ôÔºåÊàñÂú®Ë©≥ÊÉÖÈ†ÅÈù¢ÈªûÊìä„ÄåÊî∂ËóèÂÑ™ÊÉ†„ÄçÊåâÈàï„ÄÇ</p>
                            </div>
                            <div class="help-item">
                                <h4>Â¶Ç‰ΩïÊü•ÁúãÊàëÁöÑÊî∂ËóèÔºü</h4>
                                <p>ÈªûÊìäÂ∑¶ÂÅ¥ÈÇäÊ¨ÑÁöÑ„ÄåÊàëÁöÑÊî∂Ëóè„ÄçÔºåÊàñÈªûÊìäÂè≥‰∏äËßíÊúÉÂì°ÈÅ∏ÂñÆ‰∏≠ÁöÑ„ÄåÊàëÁöÑÊî∂Ëóè„Äç„ÄÇ</p>
                            </div>
                        </div>
                        
                        <!-- ÂäüËÉΩË™™Êòé -->
                        <div class="profile-section">
                            <h3 class="section-title">ÂäüËÉΩË™™Êòé</h3>
                            <div class="help-item">
                                <h4>üè† È¶ñÈ†Å</h4>
                                <p>È°ØÁ§∫ÊâÄÊúâÂèØÁî®ÁöÑÂÑ™ÊÉ†Âà∏</p>
                            </div>
                            <div class="help-item">
                                <h4>‚ù§Ô∏è ÊàëÁöÑÊî∂Ëóè</h4>
                                <p>Êü•ÁúãÂ∑≤Êî∂ËóèÁöÑÂÑ™ÊÉ†Âà∏</p>
                            </div>
                            <div class="help-item">
                                <h4>üïí ÁÄèË¶ΩË®òÈåÑ</h4>
                                <p>Êü•ÁúãÊúÄËøëÁÄèË¶ΩÈÅéÁöÑÂÑ™ÊÉ†Âà∏</p>
                            </div>
                            <div class="help-item">
                                <h4>üî• ÁÜ±ÈñÄÂÑ™ÊÉ†</h4>
                                <p>ÊåâÁÄèË¶ΩÊ¨°Êï∏ÊéíÂ∫èÁöÑÁÜ±ÈñÄÂÑ™ÊÉ†Âà∏</p>
                            </div>
                            <div class="help-item">
                                <h4>üìç ÈôÑËøëÂÑ™ÊÉ†</h4>
                                <p>Âü∫ÊñºÂú∞ÁêÜ‰ΩçÁΩÆÁöÑÈôÑËøëÂÑ™ÊÉ†ÔºàÊ®°Êì¨ÂäüËÉΩÔºâ</p>
                            </div>
                            <div class="help-item">
                                <h4>‚è∞ ÈôêÊôÇÊ¥ªÂãï</h4>
                                <p>Âç≥Â∞áÂà∞ÊúüÁöÑÈôêÊôÇÂÑ™ÊÉ†Âà∏</p>
                            </div>
                        </div>
                        
                        <!-- ËÅØÁµ°Ë≥áË®ä -->
                        <div class="profile-section">
                            <h3 class="section-title">ËÅØÁµ°ÊàëÂÄë</h3>
                            <div class="help-item">
                                <p><strong>ÂÆ¢Êúç‰ø°ÁÆ±Ôºö</strong> support@songhokang.com</p>
                                <p><strong>ÂÆ¢ÊúçÈõªË©±Ôºö</strong> 0800-123-456</p>
                                <p><strong>ÊúçÂãôÊôÇÈñìÔºö</strong> ÈÄ±‰∏ÄËá≥ÈÄ±‰∫î 09:00-18:00</p>
                            </div>
                        </div>
                        
                        <div class="profile-actions">
                            <button onclick="closeHelp()" class="btn-primary">ÈóúÈñâ</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(helpModal);
            document.body.style.overflow = 'hidden';

            // Ê∑ªÂä†ÈªûÊìäËÉåÊôØÈóúÈñâÂäüËÉΩ
            addClickOutsideToClose(helpModal, closeHelp);
        }

        function closeHelp() {
            const modal = document.querySelector('.modal-overlay:last-child');
            if (modal) {
                modal.remove();
                document.body.style.overflow = 'auto';
            }
        }

        // ÈÄöÁî®ÂáΩÊï∏ÔºöÁÇ∫Ê®°ÊÖãË¶ñÁ™óÊ∑ªÂä†ÈªûÊìäËÉåÊôØÈóúÈñâÂäüËÉΩ
        function addClickOutsideToClose(modalElement, closeFunction) {
            modalElement.addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    closeFunction();
                }
            });
        }

        // Ê∑ªÂä†Âà∞ÁÄèË¶ΩË®òÈåÑ
        function addToHistory(coupon) {
            const existingIndex = historyData.findIndex(item => item.id === coupon.id);
            if (existingIndex !== -1) {
                historyData.splice(existingIndex, 1);
            }

            historyData.unshift({
                id: coupon.id,
                timestamp: Date.now()
            });

            // ÈôêÂà∂Ë®òÈåÑÊï∏Èáè
            if (historyData.length > 50) {
                historyData = historyData.slice(0, 50);
            }

            localStorage.setItem('viewHistory', JSON.stringify(historyData));
            updateSidebarCounts();
        }

        // Áç≤ÂèñÈ†ÅÈù¢ÁâπÂÆöÁöÑÂàáÊèõÁãÄÊÖãÈçµÂÄº
        function getPageSwitchKey() {
            // Ê†πÊìöÁï∂ÂâçÈ†ÅÈù¢Ë∑ØÂæëÁîüÊàêÂîØ‰∏ÄÁöÑÂàáÊèõÁãÄÊÖãÈçµÂÄº
            const path = window.location.pathname;
            if (path.includes('vendor')) return 'switched_from_admin_vendor';
            if (path.includes('admin')) return 'switched_from_admin_admin';
            return 'switched_from_admin_customer'; // ÂâçÂè∞È†ÅÈù¢
        }

        // ËôïÁêÜÁÆ°ÁêÜÂì°ÂàáÊèõÊúÉË©±
        function handleAdminSwitch() {
            const urlParams = new URLSearchParams(window.location.search);
            const switchSessionId = urlParams.get('switch_session');

            if (switchSessionId) {
                try {
                    // Âæû sessionStorage Áç≤ÂèñÂàáÊèõÊï∏Êìö
                    const switchDataStr = sessionStorage.getItem(switchSessionId);
                    if (switchDataStr) {
                        const switchData = JSON.parse(switchDataStr);

                        // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÈöîÈõ¢ÊúÉË©±Ê®°Âºè
                        if (switchData.isolatedSession) {
                            console.log('ËôïÁêÜÈöîÈõ¢ÊúÉË©±ÂàáÊèõ:', switchData);

                            // ‰øùÂ≠òÁï∂ÂâçÈ†ÅÈù¢ÁöÑÂéüÂßãÊúÉË©±ÁãÄÊÖãÔºàÂ¶ÇÊûúÊúâÁöÑË©±Ôºâ
                            const currentPageSession = {
                                token: localStorage.getItem(LS_TOKEN),
                                user: localStorage.getItem(LS_USER),
                                timestamp: Date.now()
                            };

                            // Â¶ÇÊûúÁï∂ÂâçÈ†ÅÈù¢ÊúâÊúÉË©±Ôºå‰øùÂ≠òÂà∞Ëá®ÊôÇ‰ΩçÁΩÆ
                            const tempSessionKey = `temp_original_session_${switchData.user.role}`;
                            if (currentPageSession.token) {
                                localStorage.setItem(tempSessionKey, JSON.stringify(currentPageSession));
                            }

                            // ‰ΩøÁî®ËßíËâ≤Â∞àÂ±¨ÁöÑÈçµÂÄºË®≠ÁΩÆÊúÉË©±ÔºåÈÅøÂÖçÂΩ±ÈüøÂÖ∂‰ªñËßíËâ≤
                            const targetTokenKey = switchData.targetTokenKey || LS_TOKEN;
                            const targetUserKey = switchData.targetUserKey || LS_USER;

                            localStorage.setItem(targetTokenKey, switchData.token);
                            localStorage.setItem(targetUserKey, JSON.stringify(switchData.user));

                            // ÁÇ∫‰∫ÜÂÖºÂÆπÁèæÊúâ‰ª£Á¢ºÔºå‰πüË®≠ÁΩÆÈÄöÁî®ÈçµÂÄºÔºà‰ΩÜÈÄôÂè™ÂΩ±ÈüøÁï∂ÂâçÂàÜÈ†ÅÔºâ
                            localStorage.setItem(LS_TOKEN, switchData.token);
                            localStorage.setItem(LS_USER, JSON.stringify(switchData.user));

                            currentUser = switchData.user;

                            // ‰ΩøÁî®È†ÅÈù¢ÁâπÂÆöÁöÑÈçµÂÄºÂÑ≤Â≠òÁÆ°ÁêÜÂì°ÂàáÊèõË≥áË®ä
                            const pageSwitchKey = getPageSwitchKey();
                            const switchInfo = {
                                ...switchData.switched_from_admin,
                                isolatedSession: true,
                                targetRole: switchData.user.role,
                                originalSession: switchData.originalSession,
                                tempSession: currentPageSession,
                                pageType: pageSwitchKey // Ë®òÈåÑÈ†ÅÈù¢È°ûÂûã
                            };
                            localStorage.setItem(pageSwitchKey, JSON.stringify(switchInfo));

                        } else {
                            // ËàäÁâàÈùûÈöîÈõ¢Ê®°ÂºèÔºàÂêëÂæåÂÖºÂÆπÔºâ
                            localStorage.setItem(LS_TOKEN, switchData.token);
                            localStorage.setItem(LS_USER, JSON.stringify(switchData.user));
                            currentUser = switchData.user;
                            const pageSwitchKey = getPageSwitchKey();
                            localStorage.setItem(pageSwitchKey, JSON.stringify(switchData.switched_from_admin));
                        }

                        // Ê∏ÖÁêÜ sessionStorage
                        sessionStorage.removeItem(switchSessionId);

                        // ÁßªÈô§ URL ÂèÉÊï∏
                        window.history.replaceState({}, document.title, window.location.pathname);

                        // Âº∑Âà∂Êõ¥Êñ∞ÁôªÂÖ•UIÔºåÁ¢∫‰øùÊúÉÂì°ÈÅ∏ÂñÆÊ≠£Á¢∫È°ØÁ§∫
                        setTimeout(() => {
                            updateLoginUI();
                        }, 100);

                        // È°ØÁ§∫ÂàáÊèõÊàêÂäüÊ∂àÊÅØ
                        setTimeout(() => {
                            showSuccessMessage(`üîÑ Â∑≤ÂàáÊèõÂà∞Áî®Êà∂„Äå${switchData.user.username}„Äç\n‚úÖ È†ÅÈù¢ÈöîÈõ¢Ê®°ÂºèÔºöÂÖ∂‰ªñÈ†ÅÈù¢ÊúÉË©±‰∏çÂèóÂΩ±Èüø\n\nÈªûÊìäÂè≥‰∏äËßíüë§ÂúñÊ®ôÂèØÈÄ≤ÂÖ•ÂÄã‰∫∫‰∏≠ÂøÉ`);
                        }, 500);

                        console.log('ÁÆ°ÁêÜÂì°ÂàáÊèõÊúÉË©±ËôïÁêÜÂÆåÊàê:', switchData.user);
                    }
                } catch (error) {
                    console.error('ËôïÁêÜÁÆ°ÁêÜÂì°ÂàáÊèõÊúÉË©±Â§±Êïó:', error);
                }
            }
        }

        // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÁÆ°ÁêÜÂì°ÂàáÊèõÁöÑÊúÉË©±
        function isAdminSwitchedSession() {
            const pageSwitchKey = getPageSwitchKey();
            return localStorage.getItem(pageSwitchKey) !== null;
        }

        // È°ØÁ§∫ÁÆ°ÁêÜÂì°ÂàáÊèõÁãÄÊÖã
        function showAdminSwitchStatus() {
            if (isAdminSwitchedSession()) {
                try {
                    const pageSwitchKey = getPageSwitchKey();
                    const switchInfo = JSON.parse(localStorage.getItem(pageSwitchKey));

                    // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÈ°ØÁ§∫ÁãÄÊÖãÂàó
                    if (document.getElementById('admin-switch-status')) {
                        return;
                    }

                    const statusDiv = document.createElement('div');
                    statusDiv.id = 'admin-switch-status';
                    statusDiv.style.cssText = `
                        position: fixed;
                        bottom: 0;
                        left: 0;
                        right: 0;
                        background: linear-gradient(135deg, #f59e0b, #d97706);
                        color: white;
                        padding: 12px 16px;
                        text-align: center;
                        font-size: 14px;
                        font-weight: 600;
                        z-index: 9999;
                        box-shadow: 0 -2px 10px rgba(245, 158, 11, 0.3);
                        backdrop-filter: blur(10px);
                    `;

                    const switchTime = switchInfo.switched_at ? new Date(switchInfo.switched_at).toLocaleString() : 'Êú™Áü•';
                    statusDiv.innerHTML = `
                        üîÑ ÁÆ°ÁêÜÂì°ÂàáÊèõÊ®°Âºè | ÁõÆÂâçË∫´‰ªΩ: ${getUser()?.username || currentUser?.username || 'Êú™Áü•'} | 
                        È†ÅÈù¢: ÂâçÂè∞ | ÂàáÊèõÊôÇÈñì: ${switchTime} | 
                        <button onclick="clearAdminSwitch()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 6px; margin-left: 8px; cursor: pointer; font-size: 13px; transition: all 0.2s ease;">ÁµêÊùüÂàáÊèõ</button>
                    `;

                    document.body.appendChild(statusDiv);

                    // Ë™øÊï¥È†ÅÈù¢Â∫ïÈÉ®ÈÇäË∑ùÔºåÈÅøÂÖçÂÖßÂÆπË¢´ÈÅÆÊìã
                    document.body.style.paddingBottom = '60px';
                } catch (error) {
                    console.error('È°ØÁ§∫ÁÆ°ÁêÜÂì°ÂàáÊèõÁãÄÊÖãÂ§±Êïó:', error);
                }
            }
        }

        // Ê∏ÖÈô§ÁÆ°ÁêÜÂì°ÂàáÊèõÁãÄÊÖã
        function clearAdminSwitch() {
            if (confirm('Á¢∫ÂÆöË¶ÅÁµêÊùüÁÆ°ÁêÜÂì°ÂàáÊèõÊ®°ÂºèÂóéÔºüÈÄôÂ∞áÊ∏ÖÈô§Áï∂ÂâçÈ†ÅÈù¢ÁöÑÊúÉË©±„ÄÇ')) {
                try {
                    // Áç≤ÂèñÈ†ÅÈù¢ÁâπÂÆöÁöÑÂàáÊèõË≥áË®ä
                    const pageSwitchKey = getPageSwitchKey();
                    const switchInfoStr = localStorage.getItem(pageSwitchKey);
                    let switchInfo = null;

                    if (switchInfoStr) {
                        switchInfo = JSON.parse(switchInfoStr);
                    }

                    // Ê∏ÖÈô§Áï∂ÂâçÈ†ÅÈù¢ÁöÑÂàáÊèõÁõ∏ÈóúË≥áË®ä
                    localStorage.removeItem(pageSwitchKey);

                    // Â¶ÇÊûúÊòØÈöîÈõ¢ÊúÉË©±Ê®°ÂºèÔºåÂòóË©¶ÊÅ¢Âæ©ÂéüÂßãÊúÉË©±
                    if (switchInfo && switchInfo.isolatedSession) {
                        console.log('ÊÅ¢Âæ©È†ÅÈù¢ÈöîÈõ¢ÊúÉË©±Ê®°ÂºèÁöÑÂéüÂßãÁãÄÊÖã');

                        // Ê∏ÖÈô§Áï∂ÂâçÂàáÊèõÁöÑÊúÉË©±
                        if (switchInfo.targetRole) {
                            const targetTokenKey = `authToken_${switchInfo.targetRole}`;
                            const targetUserKey = `user_${switchInfo.targetRole}`;
                            localStorage.removeItem(targetTokenKey);
                            localStorage.removeItem(targetUserKey);
                        }

                        // ÊÅ¢Âæ©ÂéüÂßãÈ†ÅÈù¢ÊúÉË©±ÔºàÂ¶ÇÊûúÊúâÁöÑË©±Ôºâ
                        const tempSessionKey = `temp_original_session_${switchInfo.targetRole}`;
                        const tempSessionStr = localStorage.getItem(tempSessionKey);
                        if (tempSessionStr) {
                            try {
                                const tempSession = JSON.parse(tempSessionStr);
                                if (tempSession.token) {
                                    localStorage.setItem(LS_TOKEN, tempSession.token);
                                    localStorage.setItem(LS_USER, tempSession.user);
                                }
                                localStorage.removeItem(tempSessionKey);
                            } catch (e) {
                                console.error('ÊÅ¢Âæ©ÂéüÂßãÊúÉË©±Â§±Êïó:', e);
                            }
                        } else {
                            // Ê≤íÊúâÂéüÂßãÊúÉË©±ÔºåÊ∏ÖÈô§ÈÄöÁî®ÈçµÂÄº
                            localStorage.removeItem(LS_TOKEN);
                            localStorage.removeItem(LS_USER);
                        }
                    } else {
                        // ÈùûÈöîÈõ¢Ê®°ÂºèÔºåÊ∏ÖÈô§ÈÄöÁî®ÊúÉË©±
                        localStorage.removeItem(LS_TOKEN);
                        localStorage.removeItem(LS_USER);
                    }

                    currentUser = null;

                    // ÁßªÈô§ÁãÄÊÖãÂàó
                    const statusDiv = document.getElementById('admin-switch-status');
                    if (statusDiv) {
                        statusDiv.remove();
                    }

                    // ÊÅ¢Âæ©È†ÅÈù¢ÈÇäË∑ù
                    document.body.style.paddingBottom = '';

                    // ÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢
                    window.location.reload();

                } catch (error) {
                    console.error('Ê∏ÖÈô§ÂàáÊèõÁãÄÊÖãÂ§±Êïó:', error);
                    // ÁôºÁîüÈåØË™§ÊôÇÔºåÂº∑Âà∂Ê∏ÖÁêÜÊâÄÊúâÁõ∏ÈóúÊï∏Êìö
                    const pageSwitchKey = getPageSwitchKey();
                    localStorage.removeItem(pageSwitchKey);
                    localStorage.removeItem('temp_original_session_customer');
                    localStorage.removeItem('temp_original_session_vendor');
                    localStorage.removeItem(LS_TOKEN);
                    localStorage.removeItem(LS_USER);
                    window.location.reload();
                }
            }
        }

        // ‰∫ã‰ª∂Áõ£ËÅΩÂô®
        document.addEventListener('DOMContentLoaded', function () {
            // ÂàùÂßãÂåñÁï∂ÂâçÁî®Êà∂
            currentUser = getUser();

            // ËôïÁêÜÁÆ°ÁêÜÂì°ÂàáÊèõÊúÉË©±
            handleAdminSwitch();

            // Ê™¢Êü•Ë™çË≠â‰∏¶È°ØÁ§∫ÂàáÊèõÁãÄÊÖã
            setTimeout(() => {
                showAdminSwitchStatus();
            }, 100);

            loadCouponsFromApi();
            loadCategories();
            setupSidebarToggle();
            renderSearchHistory();

            // Ê∏ÖÁêÜÁÑ°ÊïàÁöÑÁÄèË¶ΩË®òÈåÑ
            setTimeout(() => {
                const validHistoryData = historyData.filter(item =>
                    coupons.some(coupon => coupon.id === item.id)
                );

                if (validHistoryData.length !== historyData.length) {
                    historyData = validHistoryData;
                    localStorage.setItem('viewHistory', JSON.stringify(historyData));
                }

                updateSidebarCounts();
            }, 1000); // Á≠âÂæÖÂÑ™ÊÉ†Âà∏Êï∏ÊìöËºâÂÖ•ÂÆåÊàê

            updateSidebarCounts();

            // ÊáâÁî®Áî®Êà∂Ë®≠ÂÆö
            const settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
            applySettings(settings);

            // Ë°åÂãïÁâàÂÅ¥Ê¨ÑÂàáÊèõ
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            const sidebar = document.querySelector('.sidebar');
            const backdrop = document.getElementById('backdrop');
            const closeMobileMenu = () => { sidebar.classList.remove('open'); backdrop.style.display = 'none'; hamburgerBtn.setAttribute('aria-expanded', 'false'); };
            const openMobileMenu = () => { sidebar.classList.add('open'); backdrop.style.display = 'block'; hamburgerBtn.setAttribute('aria-expanded', 'true'); };
            hamburgerBtn.addEventListener('click', () => {
                if (sidebar.classList.contains('open')) { closeMobileMenu(); } else { openMobileMenu(); }
            });
            backdrop.addEventListener('click', closeMobileMenu);
            // ÂÅ¥ÈÇäÊ¨ÑÈ†ÖÁõÆÈªûÊìä‰∫ã‰ª∂
            document.querySelectorAll('.sidebar-item[data-action]').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const action = item.getAttribute('data-action');
                    if (action) {
                        handleSidebarAction(action);
                        // Ë°åÂãïÁâàËá™ÂãïÈóúÈñâÂÅ¥ÈÇäÊ¨Ñ
                        if (window.innerWidth <= 768) {
                            closeMobileMenu();
                        }
                    }
                });
            });

            // ÁôªÂÖ•ÊåâÈàïËàáÁãÄÊÖã
            const loginBtn = document.querySelector('.login-btn');
            updateLoginUI();
            const roleMenu = document.getElementById('roleMenu');
            const toggleRoleMenu = () => { roleMenu.classList.toggle('active'); };
            loginBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleRoleMenu(); });
            document.addEventListener('click', (e) => { if (!e.target.closest('#roleMenu')) roleMenu.classList.remove('active'); });
            // ÈªûËßíËâ≤È†ÖÁõÆÔºàÂÉÖÂ∞çÊúâdata-roleÂ±¨ÊÄßÁöÑÂÖÉÁ¥†ÁîüÊïàÔºâ
            document.querySelectorAll('#roleMenu .role-item[data-role]').forEach(btn => btn.addEventListener('click', (e) => {
                const role = e.currentTarget.getAttribute('data-role');
                if (!role) return; // Â¶ÇÊûúÊ≤íÊúâdata-roleÂ±¨ÊÄßÔºå‰∏çÂü∑Ë°å
                roleMenu.classList.remove('active');
                window.__selectedRole = role; // Ë®≠ÂÆöÈ†êÈÅ∏ËßíËâ≤Ôºå‰æõ openAuth ‰ΩøÁî®
                if (role === 'admin') { openAuth('login'); }
                else if (role === 'vendor') { openAuth('register'); }
                else { openAuth('register'); }
            }));

            // Auth modal ‰∫ã‰ª∂
            document.getElementById('authClose').addEventListener('click', (e) => { e.stopPropagation(); closeAuth(); });
            document.getElementById('authOverlay').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    closeAuth();
                }
            });
            document.getElementById('tabLogin').addEventListener('click', () => openAuth('login'));
            document.getElementById('tabRegister').addEventListener('click', () => openAuth('register'));
            document.getElementById('loginForm').addEventListener('submit', onLoginSubmit);
            document.getElementById('registerForm').addEventListener('submit', onRegisterSubmit);

            // Ë®ªÂÜäËßíËâ≤ÂàáÊèõÊôÇÈ°ØÁ§∫/Èö±ËóèÂª†ÂïÜÊ¨Ñ‰Ωç
            // Â∑≤ÁßªÈô§ËßíËâ≤ÂàáÊèõÔºå‰øùÁïôÊ¨Ñ‰ΩçÈ°ØÁ§∫Áî± openAuth ÊéßÂà∂

            // ÊêúÂ∞ãÊ°Ü‰∫ã‰ª∂
            const searchInput = document.getElementById('searchInput');
            const searchDropdown = document.getElementById('searchDropdown');
            const searchWrapper = document.getElementById('searchWrapper');

            // ÈªûÊìäÊêúÂ∞ãÊ°ÜÂÆπÂô®ÊôÇËÅöÁÑ¶Âà∞Ëº∏ÂÖ•Ê°Ü
            searchWrapper.addEventListener('click', (e) => {
                if (e.target !== searchInput) {
                    searchInput.focus();
                }
            });

            searchInput.addEventListener('focus', () => {
                searchDropdown.classList.add('active');
                updateDropdownSelection(); // Êõ¥Êñ∞ÈÅ∏‰∏≠ÁãÄÊÖã
            });

            // Êåâ Enter ÈçµÊôÇÂü∑Ë°åÊêúÂ∞ã
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const searchTerm = searchInput.value.trim();
                    if (searchTerm) {
                        saveSearchHistory(searchTerm);
                        performSearch();
                        searchDropdown.classList.remove('active');
                    }
                }
            });

            // Ëº∏ÂÖ•ÊôÇÂç≥ÊôÇÁØ©ÈÅ∏Ôºà‰∏çË®òÈåÑÊêúÂ∞ãÁ¥ÄÈåÑÔºâ
            searchInput.addEventListener('input', () => {
                performSearch();
            });

            // ÈªûÊìäÊêúÂ∞ãÊ°ÜÂ§ñÈÉ®ÈóúÈñâ‰∏ãÊãâÈÅ∏ÂñÆ
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-container')) {
                    searchDropdown.classList.remove('active');
                    closeFilterPanel();
                }
            });

            // ÈÄ≤ÈöéÁØ©ÈÅ∏ÊåâÈàï‰∫ã‰ª∂
            document.getElementById('filterToggleBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFilterPanel();
            });

            // Logo ÈªûÊìäÂõûÈ¶ñÈ†Å‰∫ã‰ª∂
            document.querySelector('.logo').addEventListener('click', (e) => {
                e.preventDefault();
                resetToHomepage();
            });

            // ËàäÁöÑÂÅ¥ÈÇäÊ¨Ñ‰∫ã‰ª∂Áõ£ËÅΩÂô®Â∑≤ÁßªÈô§Ôºå‰ΩøÁî®Êñ∞ÁöÑdata-actionÂ±¨ÊÄßËôïÁêÜ

            // ÊúÄËøëÊêúÂ∞ãÈ†ÖÁõÆÈªûÊìä‰∫ã‰ª∂
            document.querySelectorAll('.recent-item').forEach(item => {
                item.addEventListener('click', () => {
                    const searchTerm = item.getAttribute('data-search');
                    addTag(searchTerm, 'search');
                    document.getElementById('searchDropdown').classList.remove('active');
                });
            });

            // ÂàÜÈ°ûÊ®ôÁ±§ÈªûÊìä‰∫ã‰ª∂ (ÊîØÊè¥Ë§áÈÅ∏)
            document.querySelectorAll('.category-chip').forEach(item => {
                item.addEventListener('click', () => {
                    const category = item.getAttribute('data-category');
                    const categoryText = item.querySelector('.category-chip-text').textContent;

                    // Ê™¢Êü•ÊòØÂê¶Â∑≤ÈÅ∏‰∏≠
                    const isSelected = selectedTags.some(tag => tag.text === categoryText);

                    if (isSelected) {
                        // Â¶ÇÊûúÂ∑≤ÈÅ∏‰∏≠ÔºåÂâáÁßªÈô§
                        removeTag(categoryText);
                    } else {
                        // Â¶ÇÊûúÊú™ÈÅ∏‰∏≠ÔºåÂâáÊ∑ªÂä†‰∏¶‰øùÂ≠òÊêúÂ∞ãÁ¥ÄÈåÑ
                        addTag(categoryText, 'category');
                        saveSearchHistory(categoryText);
                    }

                    updateDropdownSelection();
                });
            });

            // ÁÜ±ÈñÄÊ®ôÁ±§ÈªûÊìä‰∫ã‰ª∂ (ÊîØÊè¥Ë§áÈÅ∏)
            document.querySelectorAll('.trending-tag').forEach(item => {
                item.addEventListener('click', () => {
                    const tag = item.getAttribute('data-tag');

                    // Ê™¢Êü•ÊòØÂê¶Â∑≤ÈÅ∏‰∏≠
                    const isSelected = selectedTags.some(selectedTag => selectedTag.text === tag);

                    if (isSelected) {
                        // Â¶ÇÊûúÂ∑≤ÈÅ∏‰∏≠ÔºåÂâáÁßªÈô§
                        removeTag(tag);
                    } else {
                        // Â¶ÇÊûúÊú™ÈÅ∏‰∏≠ÔºåÂâáÊ∑ªÂä†‰∏¶‰øùÂ≠òÊêúÂ∞ãÁ¥ÄÈåÑ
                        addTag(tag, 'trending');
                        saveSearchHistory(tag);
                    }

                    updateDropdownSelection();
                });
            });

            // ÂΩàÁ™óÈóúÈñâ‰∫ã‰ª∂
            document.getElementById('modalClose').addEventListener('click', (e) => { e.stopPropagation(); closeModal(); });
            document.getElementById('modalOverlay').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    closeModal();
                }
            });
            // ÁáàÁÆ±ÈóúÈñâ‰∫ã‰ª∂
            const lightboxOverlay = document.getElementById('lightboxOverlay');
            lightboxOverlay.addEventListener('click', (e) => {
                // ÈªûÊìäÈªëËâ≤ÂçÄÂüüÊàñÂè≥‰∏äËßíÈóúÈñâÊåâÈàïÁöÜÂèØÈóúÈñâ
                if (e.target === e.currentTarget || e.target.id === 'lightboxClose') {
                    closeLightbox();
                }
            });
            document.getElementById('lightboxClose').addEventListener('click', closeLightbox);

            // ESC ÈçµÈóúÈñâÂΩàÁ™ó
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                    closeLightbox();
                }
            });
        });

        // ÁôªÂÖ• UI ÊéßÂà∂
        function updateLoginUI() {
            const btn = document.querySelector('.login-btn');
            const roleMenu = document.getElementById('roleMenu');
            if (!btn) return;

            if (isLoggedIn()) {
                const user = getUser();
                const role = (user?.role || '').toLowerCase();

                const avatarUrl = user?.avatar ? (user.avatar.startsWith('http') ? user.avatar : (user.avatar.startsWith('/') ? user.avatar : '/' + user.avatar)) : '';

                if (role === 'customer') {
                    // ‰∏ÄËà¨ÊúÉÂì°ÔºöÈ°ØÁ§∫È†≠ÂÉèÔºàÊúâÂâáÁî®ÂúñÔºåÁÑ°ÂâáÈ°ØÁ§∫ÂúñÁ§∫Ôºâ
                    btn.innerHTML = avatarUrl
                        ? `<img src="${avatarUrl}" alt="avatar" style="width:24px;height:24px;border-radius:50%;object-fit:cover;">`
                        : `<span style="color: #FCA311;">üë§</span>`;
                    btn.title = `ÊúÉÂì°Ôºö${user?.username || user?.email || 'Êú™Áü•'}`;

                    // Êõ¥Êñ∞ËßíËâ≤ÈÅ∏ÂñÆÁÇ∫Á∞°ÂåñÁöÑÊúÉÂì°ÈÅ∏ÂñÆ
                    roleMenu.innerHTML = `
                        <div style="padding: 8px 12px; border-bottom: 1px solid rgba(0,0,0,0.1); margin-bottom: 4px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 2px;">ÊúÉÂì°</div>
                            <div style="font-size: 14px; font-weight: 600; color: #333;">${user?.username || user?.email || 'Êú™Áü•Áî®Êà∂'}</div>
                        </div>
                        <button class="role-item member-action" onclick="goToProfile()">
                            <span style="margin-right: 8px;">üë§</span>ÂÄã‰∫∫‰∏≠ÂøÉ
                        </button>
                        <button class="role-item member-action" onclick="viewFavorites()">
                            <span style="margin-right: 8px;">‚ù§Ô∏è</span>ÊàëÁöÑÊî∂Ëóè <span class="menu-badge" id="menuFavCount"></span>
                        </button>
                        <div style="border-top: 1px solid rgba(0,0,0,0.1); margin-top: 4px; padding-top: 4px;">
                            <button class="role-item member-action" onclick="logout()" style="color: #dc2626;">
                                <span style="margin-right: 8px;">üö™</span>ÁôªÂá∫
                            </button>
                        </div>
                    `;

                    // ÁßªÈô§ÊâÄÊúâËàäÁöÑdata-roleÂ±¨ÊÄßÔºåÈÅøÂÖç‰∫ã‰ª∂Áõ£ËÅΩÂô®Ë°ùÁ™Å
                    document.querySelectorAll('#roleMenu .role-item').forEach(item => {
                        item.removeAttribute('data-role');
                    });

                    // Êõ¥Êñ∞ÊúÉÂì°ÈÅ∏ÂñÆ‰∏≠ÁöÑÂæΩÁ´†Ë®àÊï∏
                    updateSimpleMemberMenuBadges();
                } else {
                    // ÁÆ°ÁêÜÂì°ÊàñÂª†ÂïÜÔºöÈ°ØÁ§∫È†≠ÂÉèÊàñÁôªÂá∫ÂúñÁ§∫
                    if (avatarUrl) {
                        btn.innerHTML = `<img src="${avatarUrl}" alt="avatar" style="width:24px;height:24px;border-radius:50%;object-fit:cover;">`;
                    } else {
                        btn.textContent = '‚éã';
                    }
                    btn.title = 'ÁôªÂá∫';
                    roleMenu.innerHTML = `
                        <button class="role-item" onclick="logout()" style="color: #dc2626;">
                            <span style="margin-right: 8px;">üö™</span>ÁôªÂá∫
                        </button>
                    `;
                }
            } else {
                // Êú™ÁôªÂÖ•ÔºöÈ°ØÁ§∫ËßíËâ≤ÈÅ∏Êìá
                btn.textContent = 'üë§';
                btn.title = 'ÁôªÂÖ•';
                roleMenu.innerHTML = `
                    <button class="role-item" data-role="customer">‰∏ÄËà¨Áî®Êà∂</button>
                    <button class="role-item" data-role="vendor">Âª†ÂïÜÂæåÂè∞</button>
                    <button class="role-item" data-role="admin">ÁÆ°ÁêÜÂæåÂè∞</button>
                `;

                // ÈáçÊñ∞Á∂ÅÂÆöËßíËâ≤ÈÅ∏Êìá‰∫ã‰ª∂ÔºàÂÉÖÈÅ©Áî®ÊñºÊú™ÁôªÂÖ•ÁãÄÊÖãÁöÑËßíËâ≤ÈÅ∏ÂñÆÔºâ
                setTimeout(() => {
                    document.querySelectorAll('#roleMenu .role-item[data-role]').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const role = e.currentTarget.getAttribute('data-role');
                            if (!role) return; // Â¶ÇÊûúÊ≤íÊúâdata-roleÂ±¨ÊÄßÔºå‰∏çÂü∑Ë°å
                            roleMenu.classList.remove('active');
                            window.__selectedRole = role;
                            if (role === 'admin') { openAuth('login'); }
                            else if (role === 'vendor') { openAuth('register'); }
                            else { openAuth('register'); }
                        });
                    });
                }, 100);
            }
        }

        // ÊúÉÂì°ÂäüËÉΩÂ∑≤Êï¥ÂêàÂà∞Áç®Á´ãÁöÑÂÄã‰∫∫È†ÅÈù¢ (profile.html)






        async function viewFavorites() {
            document.getElementById('roleMenu').classList.remove('active');

            // Â¶ÇÊûúÂ∑≤ÁôªÂÖ•ÔºåÂæûAPIËºâÂÖ•Êî∂ËóèÂàóË°®
            if (isLoggedIn()) {
                try {
                    const res = await fetch('api/favorites', {
                        headers: { 'Authorization': `Bearer ${getToken()}` }
                    });
                    const json = await res.json();
                    if (json.success && json.data?.favorites) {
                        // Êõ¥Êñ∞Êú¨Âú∞Êî∂ËóèÂàóË°®
                        const favoriteIds = json.data.favorites.map(fav => fav.id);
                        setFavorites(favoriteIds);
                    }
                } catch (e) {
                    console.warn('ËºâÂÖ•Êî∂ËóèÂàóË°®Â§±Êïó:', e);
                }
            }

            // Ë®≠ÁΩÆÂÅ¥ÈÇäÊ¨ÑÊ¥ªÂãïÁãÄÊÖã
            setSidebarActive('favorites');
            setView('favorites');
            renderCoupons(); // ÈáçÊñ∞Ê∏≤ÊüìÂÑ™ÊÉ†Âà∏‰ª•È°ØÁ§∫Êî∂ËóèÂÖßÂÆπ
            showSuccessMessage('ÂàáÊèõÂà∞Êî∂ËóèÈ†ÅÈù¢');
        }

        function viewHistory() {
            document.getElementById('roleMenu').classList.remove('active');

            // Áõ¥Êé•‰ΩøÁî®ÂÅ¥ÈÇäÊ¨ÑÁöÑÊ≠∑Âè≤Ë®òÈåÑÂäüËÉΩ
            setSidebarActive('history');
            showHistory();
            showSuccessMessage(`Â∑≤È°ØÁ§∫ ${historyData.length} Á≠ÜÁÄèË¶ΩË®òÈåÑ`);
        }

        function logout() {
            document.getElementById('roleMenu').classList.remove('active');
            clearAuth();
            setView('home');
            showSuccessMessage('Â∑≤ÊàêÂäüÁôªÂá∫');
        }

        // Êõ¥Êñ∞Á∞°ÂåñÊúÉÂì°ÈÅ∏ÂñÆÂæΩÁ´†Ë®àÊï∏
        function updateSimpleMemberMenuBadges() {
            setTimeout(() => {
                // Êî∂ËóèÊï∏Èáè
                const favCount = getFavorites().length;
                const menuFavBadge = document.getElementById('menuFavCount');
                if (menuFavBadge) {
                    if (favCount > 0) {
                        menuFavBadge.textContent = favCount;
                        menuFavBadge.classList.add('show');
                    } else {
                        menuFavBadge.classList.remove('show');
                    }
                }
            }, 100);
        }

        // Ë∑≥ËΩâÂà∞ÂÄã‰∫∫‰∏≠ÂøÉÈ†ÅÈù¢
        function goToProfile() {
            document.getElementById('roleMenu').classList.remove('active');
            window.location.href = 'profile.html';
        }

        // ÁßªÈô§Ë§áÈõúÁöÑÊúÉÂì°ÂäüËÉΩÔºåÁµ±‰∏ÄÂà∞ÂÄã‰∫∫È†ÅÈù¢ËôïÁêÜ

        // ÈÄ≤ÈöéÁØ©ÈÅ∏ÂäüËÉΩ
        function toggleFilterPanel() {
            const panel = document.getElementById('filterPanel');
            const btn = document.getElementById('filterToggleBtn');
            const isVisible = panel.style.display === 'block';

            if (isVisible) {
                closeFilterPanel();
            } else {
                openFilterPanel();
            }
        }

        function openFilterPanel() {
            const panel = document.getElementById('filterPanel');
            const btn = document.getElementById('filterToggleBtn');
            const dropdown = document.getElementById('searchDropdown');

            // ÈóúÈñâÊêúÂ∞ã‰∏ãÊãâÈÅ∏ÂñÆ
            dropdown.classList.remove('active');

            // ÈñãÂïüÁØ©ÈÅ∏Èù¢Êùø
            panel.style.display = 'block';
            btn.classList.add('active');
        }

        function closeFilterPanel() {
            const panel = document.getElementById('filterPanel');
            const btn = document.getElementById('filterToggleBtn');

            panel.style.display = 'none';
            btn.classList.remove('active');
        }

        function clearAllFilters() {
            // Ê∏ÖÈô§ÂàÜÈ°ûÁØ©ÈÅ∏
            document.querySelectorAll('#categoryFilters input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });

            // ÈáçÁΩÆÂà∞ÊúüÊôÇÈñìÁØ©ÈÅ∏
            document.querySelector('input[name="expiry"][value="all"]').checked = true;

            // ÈáçÁΩÆÊéíÂ∫èÈÅ∏È†Ö
            document.getElementById('sortSelect').value = 'default';

            // ÈáçÊñ∞ËºâÂÖ•ÊâÄÊúâÂÑ™ÊÉ†Âà∏
            renderCoupons(coupons);
            showSuccessMessage('Â∑≤Ê∏ÖÈô§ÊâÄÊúâÁØ©ÈÅ∏Ê¢ù‰ª∂');
        }

        function applyAdvancedFilters() {
            let filteredCoupons = [...coupons];

            // ÂàÜÈ°ûÁØ©ÈÅ∏
            const selectedCategories = Array.from(document.querySelectorAll('#categoryFilters input[type="checkbox"]:checked'))
                .map(cb => cb.value);

            if (selectedCategories.length > 0) {
                filteredCoupons = filteredCoupons.filter(coupon =>
                    selectedCategories.some(category => coupon.category.includes(category))
                );
            }

            // Âà∞ÊúüÊôÇÈñìÁØ©ÈÅ∏
            const expiryFilter = document.querySelector('input[name="expiry"]:checked').value;
            if (expiryFilter !== 'all') {
                const now = new Date();
                filteredCoupons = filteredCoupons.filter(coupon => {
                    if (!coupon.expiry) return expiryFilter === 'future';

                    const expiryDate = new Date(coupon.expiry.replace(/\//g, '-'));
                    const diffDays = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));

                    switch (expiryFilter) {
                        case 'week': return diffDays <= 7 && diffDays > 0;
                        case 'month': return diffDays <= 30 && diffDays > 0;
                        case 'future': return diffDays > 30;
                        default: return true;
                    }
                });
            }

            // ÊéíÂ∫è
            const sortBy = document.getElementById('sortSelect').value;
            switch (sortBy) {
                case 'newest':
                    filteredCoupons.sort((a, b) => b.id - a.id);
                    break;
                case 'expiry':
                    filteredCoupons.sort((a, b) => {
                        const dateA = a.expiry ? new Date(a.expiry.replace(/\//g, '-')) : new Date('2099-12-31');
                        const dateB = b.expiry ? new Date(b.expiry.replace(/\//g, '-')) : new Date('2099-12-31');
                        return dateA - dateB;
                    });
                    break;
                case 'popular':
                    filteredCoupons.sort((a, b) => (b.view_count || 0) - (a.view_count || 0));
                    break;
                case 'category':
                    filteredCoupons.sort((a, b) => a.category.localeCompare(b.category));
                    break;
            }

            renderCoupons(filteredCoupons);
            closeFilterPanel();

            const count = filteredCoupons.length;
            showSuccessMessage(`Â∑≤Â•óÁî®ÁØ©ÈÅ∏Ê¢ù‰ª∂ÔºåÊâæÂà∞ ${count} ÂºµÂÑ™ÊÉ†Âà∏`);
        }

        function openAuth(mode) {
            const overlay = document.getElementById('authOverlay');
            overlay.style.display = 'flex';
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            const loginF = document.getElementById('loginForm');
            const regF = document.getElementById('registerForm');
            if (mode === 'register') { loginF.style.display = 'none'; regF.style.display = 'block'; }
            else { loginF.style.display = 'block'; regF.style.display = 'none'; }
            // Ê†πÊìöÂæûËßíËâ≤ÈÅ∏ÂñÆÈªûÊìäÁöÑÈ†êË®≠ËßíËâ≤Ë™øÊï¥Ë°®ÂñÆÔºàÈö±ËóèÊàñÈ°ØÁ§∫Âª†ÂïÜÈÅ∏È†ÖËàáÊ¨Ñ‰ΩçÔºâ
            const preselected = window.__selectedRole || 'customer';
            const loginRoleRow = document.getElementById('loginRoleRow');
            const regRoleRow = document.getElementById('regRoleRow');
            const vendorFields = document.getElementById('vendorFields');
            if (preselected === 'customer') {
                if (vendorFields) vendorFields.style.display = 'none';
            } else if (preselected === 'vendor') {
                if (vendorFields) vendorFields.style.display = '';
            }
        }
        function closeAuth() {
            const overlay = document.getElementById('authOverlay');
            overlay.style.display = 'none';
            overlay.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // È°ØÁ§∫ÊàêÂäüË®äÊÅØ
        function showSuccessMessage(message) {
            // ÂâµÂª∫ÊàêÂäüÊèêÁ§∫
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #FCA311, #F79009);
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 25px rgba(252, 163, 17, 0.3);
                z-index: 9999;
                font-weight: 600;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                transform: translateX(400px);
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                max-width: 300px;
            `;
            successDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 18px;">‚úÖ</span>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(successDiv);

            // ÂãïÁï´È°ØÁ§∫
            setTimeout(() => {
                successDiv.style.transform = 'translateX(0)';
            }, 100);

            // 3ÁßíÂæåËá™ÂãïÊ∂àÂ§±
            setTimeout(() => {
                successDiv.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.parentNode.removeChild(successDiv);
                    }
                }, 400);
            }, 3000);
        }

        async function onLoginSubmit(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            if (!username || !password) { showSuccessMessage('Ë´ãÂ°´ÂØ´Â∏≥ËôüÂíåÂØÜÁ¢º'); return; }
            try {
                const res = await fetch('api/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
                const json = await res.json();
                if (json.success) {
                    setAuth(json.data.token, json.data.user);
                    const role = (json.data.user?.role || '').toLowerCase();
                    // È°çÂ§ñÂ≠ò‰∏Ä‰ªΩÂà∞ËßíËâ≤Â∞àÂ±¨ tokenÔºåÊñπ‰æøÂêåË£ùÁΩÆÂ§öÊúÉË©±
                    const roleKey = ROLE_TOKENS[role];
                    if (roleKey) localStorage.setItem(roleKey, json.data.token);
                    if (role === 'admin') {
                        showSuccessMessage('ÁôªÂÖ•ÊàêÂäüÔºåÂâçÂæÄÁÆ°ÁêÜÂæåÂè∞');
                        window.open('admin/', '_blank');
                        closeAuth();
                        return;
                    }
                    if (role === 'vendor') {
                        showSuccessMessage('ÁôªÂÖ•ÊàêÂäüÔºåÂâçÂæÄÂª†ÂïÜ‰∏≠ÂøÉ');
                        window.open('vendor/', '_blank');
                        closeAuth();
                        return;
                    }
                    if (role === 'customer') {
                        showSuccessMessage(`Ê≠°ËøéÂõû‰æÜÔºå${json.data.user?.username || 'ÊúÉÂì°'}ÔºÅ`);
                        closeAuth();
                        // ‰∏ÄËà¨ÊúÉÂì°ÁïôÂú®ÂâçÂè∞Ôºå‰∏çË∑≥ËΩâ
                        return;
                    }
                    closeAuth();
                    showSuccessMessage('ÁôªÂÖ•ÊàêÂäü');
                }
                else { showSuccessMessage(json.message || 'ÁôªÂÖ•Â§±Êïó'); }
            } catch (err) {
                console.error('ÁôªÂÖ•ÈåØË™§:', err);
                showSuccessMessage('Á∂≤Ë∑ØÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶');
            }
        }

        async function onRegisterSubmit(e) {
            e.preventDefault();
            const username = document.getElementById('regUsername').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const password2 = document.getElementById('regPassword2').value;
            const phone = document.getElementById('regPhone').value.trim();
            // ËßíËâ≤Âõ∫ÂÆöÁî± openAuth Ë®≠ÂÆö
            const role = (window.__selectedRole === 'vendor') ? 'vendor' : 'customer';
            const company_name = document.getElementById('regCompany').value.trim();
            if (!username || !email || !password) { showSuccessMessage('Ë´ãÂÆåÊï¥Â°´ÂØ´Áî®Êà∂Âêç„ÄÅÈõªÂ≠êÈÉµ‰ª∂ÂíåÂØÜÁ¢º'); return; }
            if (password !== password2) { showSuccessMessage('ÂÖ©Ê¨°ÂØÜÁ¢º‰∏ç‰∏ÄËá¥'); return; }
            if (role === 'vendor' && !company_name) { showSuccessMessage('Âª†ÂïÜË®ªÂÜäË´ãÂ°´ÂØ´ÂÖ¨Âè∏ÂêçÁ®±'); return; }
            try {
                const body = { username, email, password, confirm_password: password2, phone, role };
                if (role === 'vendor') { body.company_name = company_name; }
                const res = await fetch('api/auth/register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                let json;
                try { json = await res.clone().json(); }
                catch { const txt = await res.text(); showSuccessMessage('Ë®ªÂÜäÂ§±ÊïóÔºö' + txt); return; }
                if (json.success) {
                    showSuccessMessage('Ë®ªÂÜäÊàêÂäüÔºåË´ã‰ΩøÁî®Â∏≥ÂØÜÁôªÂÖ•');
                    setTimeout(() => openAuth('login'), 1500);
                } else {
                    const details = json.details ? (typeof json.details === 'string' ? json.details : JSON.stringify(json.details)) : '';
                    showSuccessMessage((json.message || 'Ë®ªÂÜäÂ§±Êïó') + (details ? ('Ôºö' + details) : ''));
                }
            } catch (err) {
                console.error('Ë®ªÂÜäÈåØË™§:', err);
                showSuccessMessage('Á∂≤Ë∑ØÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶');
            }
        }

        // Êî∂ËóèÈàïÔºö‰ΩøÁî®ÂΩàÁ™óÂè≥ÂÅ¥ÁöÑÊ¨°Ë¶ÅÊåâÈàï
        document.addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('btn-secondary') && currentCoupon) {
                e.preventDefault();
                toggleFavorite(currentCoupon).then(() => { syncModalFavoriteButton(); updateFavCount(); });
            }
            // Êî∂ËóèÂàóË°®‰∏≠ÁöÑÂà™Èô§ÊåâÈàïÔºà‰∫ã‰ª∂‰ª£ÁêÜÔºâ
            if (e.target && e.target.matches('[data-action="remove-fav"]')) {
                const id = Number(e.target.getAttribute('data-id'));
                const c = coupons.find(x => x.id === id);
                if (c) {
                    e.stopPropagation();
                    toggleFavorite(c).then(() => {
                        const card = e.target.closest('.coupon-card');
                        if (card) card.remove();
                        setView('favorites');
                        updateFavCount();
                    });
                }
            }
            // Âç°ÁâáÂè≥‰∏äËßíÂø´ÈÄüÊî∂Ëóè
            if (e.target && e.target.matches('[data-action="quick-fav"]')) {
                e.stopPropagation();
                const id = Number(e.target.getAttribute('data-id'));
                const c = coupons.find(x => x.id === id);
                if (c) {
                    toggleFavorite(c).then(() => {
                        // ÂàáÊèõÊÑõÂøÉÊ®£ÂºèËàáÁ¨¶Ëôü
                        const btn = e.target;
                        const nowFavs = new Set(getFavorites());
                        const active = nowFavs.has(id);
                        btn.classList.toggle('active', active);
                        btn.textContent = active ? '‚ù§' : '‚ô°';
                        updateFavCount();
                        // Ëã•Âú®Êî∂ËóèË¶ñÂúñ‰∏îÂ∑≤ÂèñÊ∂àÊî∂ËóèÔºåÁõ¥Êé•ÁßªÈô§Ë©≤Âç°Áâá
                        if (isFavoritesView() && !active) {
                            const card = btn.closest('.coupon-card');
                            if (card) card.remove();
                            // Ëã•Âà™ÂÖâÂæåÈ°ØÁ§∫Á©∫Áï´Èù¢
                            const remain = document.querySelectorAll('.coupon-card').length;
                            if (remain === 0) renderEmptyFavorites();
                        }
                    });
                }
            }
        });

        // Êõ¥Êñ∞ÂÅ¥ÈÇäÊ¨ÑÊî∂ËóèÊï∏
        function updateFavCount() {
            const el = document.getElementById('favCount');
            if (!el) return;
            const count = getFavorites().length;
            if (count > 0) { el.textContent = String(count); el.style.display = ''; }
            else { el.textContent = ''; el.style.display = 'none'; }
        }
    </script>
</body>

</html>